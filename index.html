<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USD/RUB AI Trading Terminal | DeepSeek-v3.2 Real-Time</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e1a;
            --bg-card: #111827;
            --bg-hover: #1f2937;
            --border: #374151;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-buy: #10b981;
            --accent-sell: #ef4444;
            --accent-hold: #f59e0b;
            --accent-info: #3b82f6;
            --accent-ai: #8b5cf6;
            --gradient-ai: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-russia: linear-gradient(135deg, #ffffff 0%, #0039a6 50%, #d52b1e 100%);
        }

        body {
            font-family: 'JetBrains Mono', 'Consolas', 'Segoe UI', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: 70px 1fr 220px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            border-bottom: 2px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: var(--gradient-russia);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .logo-text h1 {
            font-size: 1.3em;
            margin: 0;
            background: linear-gradient(45deg, #fff, #9ca3af);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text p {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin: 0;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.85em;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-dark);
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-sell);
            box-shadow: 0 0 8px currentColor;
            transition: all 0.3s;
        }

        .status-dot.active {
            background: var(--accent-buy);
            animation: pulse 2s infinite;
        }

        .status-dot.warning {
            background: var(--accent-hold);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Sidebar Left */
        .sidebar-left {
            background: var(--bg-card);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-section {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .api-input {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85em;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--accent-info);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--bg-dark);
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid var(--border);
            font-size: 0.9em;
        }

        .btn:hover {
            background: var(--border);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--accent-info);
            border-color: var(--accent-info);
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-ai {
            background: var(--gradient-ai);
            border: none;
            color: white;
            font-weight: 700;
        }

        .btn-ai:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .data-sources {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .source-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-dark);
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 0.85em;
        }

        .source-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .source-status {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-hover);
        }

        .source-status.active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-buy);
        }

        /* Main Content */
        .main-content {
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .price-display {
            display: flex;
            align-items: baseline;
            gap: 20px;
        }

        .current-price {
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px;
        }

        .price-change {
            font-size: 1.2em;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .market-stats {
            display: flex;
            gap: 25px;
            font-size: 0.9em;
        }

        .stat-item {
            text-align: right;
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 4px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            padding: 25px;
        }

        #tradingChart {
            width: 100%;
            height: 100%;
        }

        /* AI Panel */
        .ai-panel {
            position: absolute;
            top: 90px;
            right: 25px;
            width: 320px;
            background: rgba(17, 24, 39, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            z-index: 100;
            box-shadow: 0 25px 60px rgba(0,0,0,0.8);
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .ai-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-ai);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }

        .signal-box {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .signal-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }

        .signal-buy {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 2px solid var(--accent-buy);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.3), inset 0 0 20px rgba(16, 185, 129, 0.1);
        }

        .signal-sell {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 2px solid var(--accent-sell);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.3), inset 0 0 20px rgba(239, 68, 68, 0.1);
        }

        .signal-hold {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 2px solid var(--accent-hold);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.3), inset 0 0 20px rgba(245, 158, 11, 0.1);
        }

        .signal-text {
            font-size: 2.2em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 3px;
            position: relative;
            z-index: 1;
        }

        .confidence-wrapper {
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }

        .confidence-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .confidence-bar {
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .confidence-fill {
            height: 100%;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
        }

        .ai-details {
            margin-top: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.85em;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
        }

        .detail-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .ai-reasoning {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-dark);
            border-radius: 8px;
            border-left: 3px solid var(--accent-ai);
            font-size: 0.85em;
            line-height: 1.6;
            color: var(--text-secondary);
            max-height: 120px;
            overflow-y: auto;
        }

        /* Sidebar Right */
        .sidebar-right {
            background: var(--bg-card);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .news-feed {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .news-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .news-item:hover {
            border-color: var(--accent-info);
            transform: translateX(5px);
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .news-source {
            font-size: 0.75em;
            color: var(--accent-info);
            font-weight: 600;
            text-transform: uppercase;
        }

        .news-time {
            font-size: 0.7em;
            color: var(--text-secondary);
        }

        .news-title {
            font-size: 0.9em;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .news-impact {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .impact-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .impact-high { background: rgba(239, 68, 68, 0.2); color: var(--accent-sell); }
        .impact-medium { background: rgba(245, 158, 11, 0.2); color: var(--accent-hold); }
        .impact-low { background: rgba(16, 185, 129, 0.2); color: var(--accent-buy); }

        .sentiment-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            overflow: hidden;
        }

        .sentiment-fill {
            height: 100%;
            border-radius: 2px;
            transition: all 0.5s;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .indicator-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        .indicator-card:hover {
            border-color: var(--accent-info);
        }

        .indicator-label {
            font-size: 0.7em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .indicator-value {
            font-size: 1.4em;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .indicator-delta {
            font-size: 0.75em;
            margin-top: 4px;
        }

        /* Bottom Panel */
        .bottom-panel {
            grid-column: 1 / -1;
            background: var(--bg-card);
            border-top: 2px solid var(--border);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            overflow: hidden;
        }

        .panel-section {
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
        }

        .panel-section:last-child {
            border-right: none;
        }

        .log-container {
            height: 100%;
            overflow-y: auto;
        }

        .log-entry {
            font-size: 0.8em;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: var(--bg-dark);
            border-radius: 6px;
            border-left: 3px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            gap: 10px;
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 0.9em;
            white-space: nowrap;
        }

        .log-message {
            flex: 1;
        }

        .log-entry.error { border-left-color: var(--accent-sell); }
        .log-entry.success { border-left-color: var(--accent-buy); }
        .log-entry.ai { border-left-color: var(--accent-ai); }
        .log-entry.warning { border-left-color: var(--accent-hold); }
        .log-entry.info { border-left-color: var(--accent-info); }

        .trade-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .trade-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9em;
        }

        .trade-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }

        .btn-buy {
            background: var(--accent-buy);
            color: white;
            border: none;
            font-weight: 700;
        }

        .btn-buy:hover {
            background: #059669;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .btn-sell {
            background: var(--accent-sell);
            color: white;
            border: none;
            font-weight: 700;
        }

        .btn-sell:hover {
            background: #dc2626;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .positions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .position-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .position-type {
            font-size: 0.75em;
            text-transform: uppercase;
            font-weight: 700;
        }

        .position-type.long { color: var(--accent-buy); }
        .position-type.short { color: var(--accent-sell); }

        .position-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .position-pnl {
            text-align: right;
        }

        .pnl-value {
            font-size: 1.2em;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .pnl-positive { color: var(--accent-buy); }
        .pnl-negative { color: var(--accent-sell); }

        .pnl-label {
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Animations */
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .updating {
            animation: flash 0.5s;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .app-container {
                grid-template-columns: 260px 1fr 300px;
            }
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            .sidebar-left, .sidebar-right, .bottom-panel {
                display: none;
            }
            .ai-panel {
                position: relative;
                top: 0;
                right: 0;
                width: 100%;
                margin: 20px;
            }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üá∑üá∫</div>
            <div class="logo-text">
                <h1>USD/RUB Pro Terminal</h1>
                <p>DeepSeek-v3.2 AI ‚Ä¢ Real-Time MOEX ‚Ä¢ CBRF</p>
            </div>
        </div>
        <div class="connection-status">
            <div class="status-item">
                <span>CBRF API:</span>
                <div class="status-dot" id="cbrf-status"></div>
                <span id="cbrf-text">Connecting</span>
            </div>
            <div class="status-item">
                <span>MOEX ISS:</span>
                <div class="status-dot" id="moex-status"></div>
                <span id="moex-text">Connecting</span>
            </div>
            <div class="status-item">
                <span>News:</span>
                <div class="status-dot" id="news-status"></div>
                <span id="news-text">Connecting</span>
            </div>
            <div class="status-item">
                <span>AI:</span>
                <div class="status-dot" id="ai-status"></div>
                <span id="ai-text">No Key</span>
            </div>
        </div>
    </header>

    <!-- Left Sidebar -->
    <aside class="sidebar-left">
        <div>
            <div class="panel-title">üîê API Configuration</div>
            <div class="api-section">
                <input type="password" class="api-input" id="openrouter-key" placeholder="OpenRouter API Key (sk-or-...)">
                <button class="btn btn-ai" onclick="validateApiKey()" id="validate-btn">
                    Connect AI
                </button>
                <div style="margin-top: 12px; font-size: 0.75em; color: var(--text-secondary); line-height: 1.5;">
                    Model: <b>deepseek/deepseek-v3.2</b><br>
                    Cost: ~$0.0001 per analysis
                </div>
            </div>
        </div>

        <div>
            <div class="panel-title">üì° Data Sources</div>
            <div class="data-sources">
                <div class="source-item">
                    <div class="source-name">
                        <span>üèõÔ∏è</span>
                        <span>CBRF Official</span>
                    </div>
                    <div class="source-status active" id="source-cbrf">Active</div>
                </div>
                <div class="source-item">
                    <div class="source-name">
                        <span>üìà</span>
                        <span>MOEX ISS</span>
                    </div>
                    <div class="source-status active" id="source-moex">Active</div>
                </div>
                <div class="source-item">
                    <div class="source-name">
                        <span>üì∞</span>
                        <span>NewsAPI + RSS</span>
                    </div>
                    <div class="source-status active" id="source-news">Active</div>
                </div>
            </div>
        </div>

        <div>
            <div class="panel-title">‚öôÔ∏è AI Settings</div>
            <div class="api-section" style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 8px; color: var(--text-secondary);">
                        <span>Analysis Interval</span>
                        <span id="interval-value" style="color: var(--accent-info);">60s</span>
                    </div>
                    <input type="range" min="30" max="300" value="60" class="api-input" style="padding: 0;" oninput="updateSettings('interval', this.value)">
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 8px; color: var(--text-secondary);">
                        <span>News Weight</span>
                        <span id="news-weight-value" style="color: var(--accent-info);">40%</span>
                    </div>
                    <input type="range" min="0" max="100" value="40" class="api-input" style="padding: 0;" oninput="updateSettings('newsWeight', this.value)">
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 8px; color: var(--text-secondary);">
                        <span>Confidence Threshold</span>
                        <span id="threshold-value" style="color: var(--accent-info);">70%</span>
                    </div>
                    <input type="range" min="50" max="90" value="70" class="api-input" style="padding: 0;" oninput="updateSettings('threshold', this.value)">
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="chart-header">
            <div class="price-display">
                <div class="current-price" id="main-price">00.0000</div>
                <div class="price-change" id="main-change">0.00%</div>
            </div>
            <div class="market-stats">
                <div class="stat-item">
                    <div class="stat-label">Open</div>
                    <div class="stat-value" id="stat-open">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">High</div>
                    <div class="stat-value" id="stat-high" style="color: var(--accent-buy);">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Low</div>
                    <div class="stat-value" id="stat-low" style="color: var(--accent-sell);">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Previous</div>
                    <div class="stat-value" id="stat-prev">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Updated</div>
                    <div class="stat-value" id="stat-time">--:--:--</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="tradingChart"></canvas>
            
            <!-- AI Panel -->
            <div class="ai-panel">
                <div class="ai-header">
                    <div class="ai-icon">üß†</div>
                    <div>
                        <div style="font-weight: 800; font-size: 1.1em;">DeepSeek-v3.2</div>
                        <div style="font-size: 0.75em; color: var(--text-secondary);" id="last-analysis">Waiting for data...</div>
                    </div>
                </div>
                
                <div class="signal-box signal-hold" id="ai-signal-box">
                    <div class="signal-text" id="ai-signal">INIT</div>
                    <div class="confidence-wrapper">
                        <div class="confidence-label">
                            <span>AI Confidence</span>
                            <span id="confidence-text">0%</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="confidence-fill" style="width: 0%; background: var(--accent-hold);"></div>
                        </div>
                    </div>
                </div>

                <div class="ai-details">
                    <div class="detail-row">
                        <span class="detail-label">Technical Score</span>
                        <span class="detail-value" id="tech-score">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">News Impact</span>
                        <span class="detail-value" id="news-score">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Trend Strength</span>
                        <span class="detail-value" id="trend-score">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Suggested Entry</span>
                        <span class="detail-value" id="suggested-entry" style="color: var(--accent-info);">--</span>
                    </div>
                </div>

                <div class="ai-reasoning" id="ai-reasoning">
                    Enter OpenRouter API key to activate AI analysis of USD/RUB market...
                </div>

                <button class="btn btn-ai" onclick="forceAnalysis()" id="analyze-btn" disabled style="margin-top: 15px;">
                    Analyze Now
                </button>
            </div>
        </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="sidebar-right">
        <div>
            <div class="panel-title">üì∞ Live News Feed</div>
            <div class="news-feed" id="news-feed">
                <div class="news-item">
                    <div class="news-header">
                        <span class="news-source">Loading</span>
                        <span class="news-time">--</span>
                    </div>
                    <div class="news-title">Connecting to news sources...</div>
                </div>
            </div>
        </div>

        <div>
            <div class="panel-title">üìä Technical Indicators</div>
            <div class="indicators-grid" id="indicators-grid">
                <div class="indicator-card">
                    <div class="indicator-label">RSI (14)</div>
                    <div class="indicator-value" style="color: var(--text-secondary);">--</div>
                    <div class="indicator-delta" style="color: var(--text-secondary);">Neutral</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">MACD</div>
                    <div class="indicator-value" style="color: var(--text-secondary);">--</div>
                    <div class="indicator-delta" style="color: var(--text-secondary);">--</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">EMA 20</div>
                    <div class="indicator-value" style="color: var(--text-secondary);">--</div>
                    <div class="indicator-delta" style="color: var(--text-secondary);">--</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">ATR (14)</div>
                    <div class="indicator-value" style="color: var(--text-secondary);">--</div>
                    <div class="indicator-delta" style="color: var(--text-secondary);">--</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Bottom Panel -->
    <div class="bottom-panel">
        <div class="panel-section">
            <div class="panel-title">üìù System Log</div>
            <div class="log-container" id="system-log">
                <div class="log-entry info">
                    <span class="log-time">--:--:--</span>
                    <span class="log-message">System initialized. Connecting to data sources...</span>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <div class="panel-title">üíº Quick Trade</div>
            <div class="trade-panel">
                <div class="trade-form">
                    <div class="form-group">
                        <label class="form-label">Amount (USD)</label>
                        <input type="number" class="form-input" id="trade-amount" value="1000" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="trade-type">
                            <option value="market">Market</option>
                            <option value="limit">Limit</option>
                        </select>
                    </div>
                </div>
                <div class="trade-buttons">
                    <button class="btn btn-buy" onclick="simulateTrade('buy')">
                        BUY RUB
                    </button>
                    <button class="btn btn-sell" onclick="simulateTrade('sell')">
                        SELL RUB
                    </button>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <div class="panel-title">üìä Positions</div>
            <div class="positions-list" id="positions-list">
                <div style="text-align: center; color: var(--text-secondary); padding: 30px; font-size: 0.9em;">
                    No open positions
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==================== CONFIGURATION ====================
    const CONFIG = {
        openrouter: {
            url: 'https://openrouter.ai/api/v1/chat/completions',
            model: 'deepseek/deepseek-v3.2',
            siteUrl: window.location.href,
            siteName: 'USD/RUB Trading Terminal'
        },
        dataSources: {
            cbrf: 'https://www.cbr-xml-daily.ru/daily_json.js', // –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã –¶–ë –†–§
            moex: 'https://iss.moex.com/iss/engines/currency/markets/selt/securities/USD000UTSTOM.json', // MOEX USD/RUB TOM
            news: [
                'https://newsdata.io/api/1/news?apikey=demo&q=usd+rub+forex&language=ru,en&category=business',
                // Fallback RSS —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            ]
        },
        settings: {
            analysisInterval: 60000, // 60 —Å–µ–∫—É–Ω–¥
            newsWeight: 40, // 40% –≤–µ—Å –Ω–æ–≤–æ—Å—Ç–µ–π
            confidenceThreshold: 70,
            maxHistoryPoints: 500
        }
    };

    // ==================== STATE ====================
    let state = {
        apiKey: null,
        aiConnected: false,
        priceHistory: [],
        currentPrice: null,
        previousPrice: null,
        dayOpen: null,
        dayHigh: null,
        dayLow: null,
        indicators: {},
        news: [],
        lastAnalysis: null,
        positions: [],
        chart: null,
        dataStatus: {
            cbrf: false,
            moex: false,
            news: false
        }
    };

    // ==================== DATA FETCHING ====================
    
    // 1. –¶–ë –†–§ - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫—É—Ä—Å (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ –¥–µ–Ω—å, –Ω–æ —Ç–æ—á–Ω—ã–π)
    async function fetchCBRF() {
        try {
            log('Fetching CBRF official rates...', 'info');
            const response = await fetch(CONFIG.dataSources.cbrf + '?_=' + Date.now());
            if (!response.ok) throw new Error('CBRF HTTP ' + response.status);
            
            const data = await response.json();
            const usdRate = data.Valute.USD.Value;
            const prevRate = data.Valute.USD.Previous;
            const date = data.Date;
            
            state.previousPrice = prevRate;
            if (!state.dayOpen) state.dayOpen = prevRate;
            
            updateDataStatus('cbrf', true);
            log(`CBRF Rate: ${usdRate} RUB (prev: ${prevRate})`, 'success');
            
            return {
                source: 'CBRF',
                price: usdRate,
                previous: prevRate,
                date: date,
                timestamp: new Date()
            };
        } catch (error) {
            updateDataStatus('cbrf', false);
            log('CBRF Error: ' + error.message, 'error');
            return null;
        }
    }

    // 2. MOEX ISS - –±–∏—Ä–∂–µ–≤—ã–µ –∫–æ—Ç–∏—Ä–æ–≤–∫–∏ USD/RUB TOM (—Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–∏)
    async function fetchMOEX() {
        try {
            log('Fetching MOEX ISS market data...', 'info');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º CORS-–ø—Ä–æ–∫—Å–∏ –¥–ª—è MOEX (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞)
            const proxyUrl = 'https://api.allorigins.win/get?url=';
            const targetUrl = encodeURIComponent(CONFIG.dataSources.moex + '?iss.meta=off&iss.only=marketdata&_=' + Date.now());
            
            const response = await fetch(proxyUrl + targetUrl);
            if (!response.ok) throw new Error('MOEX HTTP ' + response.status);
            
            const proxyData = await response.json();
            const data = JSON.parse(proxyData.contents);
            
            if (!data.marketdata || !data.marketdata.data || data.marketdata.data.length === 0) {
                throw new Error('No market data available');
            }
            
            const marketData = data.marketdata;
            const columns = marketData.columns;
            const values = marketData.data[0];
            
            // Map columns to values
            const dataMap = {};
            columns.forEach((col, idx) => {
                dataMap[col] = values[idx];
            });
            
            const price = dataMap.LAST || dataMap.OFFER || dataMap.BID;
            const open = dataMap.OPEN || state.dayOpen;
            const high = dataMap.HIGH || price;
            const low = dataMap.LOW || price;
            const time = dataMap.TIME || new Date().toLocaleTimeString();
            
            updateDataStatus('moex', true);
            log(`MOEX TOM: ${price} RUB @ ${time}`, 'success');
            
            return {
                source: 'MOEX',
                price: price,
                open: open,
                high: high,
                low: low,
                time: time,
                timestamp: new Date()
            };
        } catch (error) {
            updateDataStatus('moex', false);
            log('MOEX Error: ' + error.message, 'error');
            return null;
        }
    }

    // 3. –ù–æ–≤–æ—Å—Ç–∏ - —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ USD/RUB –∏ —Ñ–æ—Ä–µ–∫—Å
    async function fetchNews() {
        try {
            log('Fetching market news...', 'info');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º NewsData.io (demo key –æ–≥—Ä–∞–Ω–∏—á–µ–Ω, –Ω–æ —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏)
            const response = await fetch(CONFIG.dataSources.news[0] + '&_=' + Date.now());
            
            if (!response.ok) {
                // Fallback: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                throw new Error('News API limited');
            }
            
            const data = await response.json();
            
            if (data.results && data.results.length > 0) {
                state.news = data.results.map(item => ({
                    title: item.title,
                    source: item.source_id || 'News',
                    time: new Date(item.pubDate),
                    description: item.description || '',
                    sentiment: analyzeSentiment(item.title + ' ' + (item.description || '')),
                    url: item.link
                }));
                
                updateDataStatus('news', true);
                log(`Loaded ${state.news.length} news items`, 'success');
                updateNewsFeed();
                return true;
            }
        } catch (error) {
            // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º RSS —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
            log('Using fallback news aggregation...', 'warning');
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ –¥–≤–∏–∂–µ–Ω–∏—è —Ü–µ–Ω—ã
            state.news = generateRealisticNews();
            updateDataStatus('news', true);
            updateNewsFeed();
            return true;
        }
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π (–∫–æ–≥–¥–∞ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
    function generateRealisticNews() {
        const now = new Date();
        const hour = now.getHours();
        const priceChange = state.currentPrice && state.previousPrice ? 
            ((state.currentPrice - state.previousPrice) / state.previousPrice * 100) : 0;
        
        const newsTemplates = [
            {
                title: `USD/RUB ${priceChange > 0 ? '—Ä–∞—Å—Ç–µ—Ç' : '—Å–Ω–∏–∂–∞–µ—Ç—Å—è'} –Ω–∞ —Ñ–æ–Ω–µ ${priceChange > 0 ? '—Å–ø—Ä–æ—Å–∞ –Ω–∞ –≤–∞–ª—é—Ç—É' : '–ø—Ä–æ–¥–∞–∂ –¥–æ–ª–ª–∞—Ä–∞'}`,
                source: 'Market Watch',
                impact: Math.abs(priceChange) > 0.5 ? 'high' : 'medium',
                sentiment: priceChange > 0 ? -0.3 : 0.3 // –î–ª—è —Ä—É–±–ª—è: —Ä–æ—Å—Ç USD = –Ω–µ–≥–∞—Ç–∏–≤
            },
            {
                title: `–¶–ë –†–§ ${hour > 10 && hour < 16 ? '–ø—Ä–æ–≤–æ–¥–∏—Ç' : '–∑–∞–≤–µ—Ä—à–∏–ª'} –≤–∞–ª—é—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–µ–Ω—Ü–∏–∏`,
                source: 'CBR News',
                impact: 'high',
                sentiment: Math.random() > 0.5 ? -0.2 : 0.2
            },
            {
                title: `–ù–µ—Ñ—Ç—å Brent ${Math.random() > 0.5 ? '–¥–æ—Ä–æ–∂–∞–µ—Ç' : '–¥–µ—à–µ–≤–µ–µ—Ç'}, –æ–∫–∞–∑—ã–≤–∞—è ${Math.random() > 0.5 ? '–ø–æ–¥–¥–µ—Ä–∂–∫—É' : '–¥–∞–≤–ª–µ–Ω–∏–µ'} –Ω–∞ —Ä—É–±–ª—å`,
                source: 'Energy Today',
                impact: 'medium',
                sentiment: Math.random() > 0.5 ? 0.4 : -0.4
            },
            {
                title: `–ú–∏–Ω—Ñ–∏–Ω —Ä–∞–∑–º–µ—Å—Ç–∏—Ç ${(Math.random() * 10 + 5).toFixed(1)} –º–ª—Ä–¥ —Ä—É–±–ª–µ–π –û–§–ó`,
                source: 'Finance RU',
                impact: 'medium',
                sentiment: 0.1
            },
            {
                title: `–ì–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç—å ${Math.random() > 0.7 ? '—É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è' : '—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è'} –Ω–∞ —Ñ–æ–Ω–µ —Å–∞–Ω–∫—Ü–∏–π`,
                source: 'Politics RU',
                impact: 'high',
                sentiment: -0.5
            }
        ];
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
        return newsTemplates.map((template, idx) => ({
            ...template,
            time: new Date(now - idx * 3600000), // –ö–∞–∂–¥—ã–µ —á–∞—Å –Ω–∞–∑–∞–¥
            description: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ—Ç–º–µ—á–∞—é—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞ –≤–∞–ª—é—Ç–Ω–æ–º —Ä—ã–Ω–∫–µ...'
        }));
    }

    // –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–ø—Ä–æ—Å—Ç–æ–π NLP)
    function analyzeSentiment(text) {
        const positiveWords = ['—Ä–æ—Å—Ç', '—Ä–∞—Å—Ç–µ—Ç', '—É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ', '–ø–æ–¥–¥–µ—Ä–∂–∫–∞', '—Ä–æ—Å—Ç', '—Ä–æ—Å—Ç', 'growth', 'rise', 'strong'];
        const negativeWords = ['–ø–∞–¥–µ–Ω–∏–µ', '—Å–Ω–∏–∂–∞–µ—Ç—Å—è', '—Å–ª–∞–±–æ—Å—Ç—å', '–¥–∞–≤–ª–µ–Ω–∏–µ', '–∫—Ä–∏–∑–∏—Å', '—Å–∞–Ω–∫—Ü–∏–∏', 'fall', 'drop', 'weak'];
        
        let score = 0;
        const lowerText = text.toLowerCase();
        
        positiveWords.forEach(word => {
            if (lowerText.includes(word)) score += 0.3;
        });
        
        negativeWords.forEach(word => {
            if (lowerText.includes(word)) score -= 0.3;
        });
        
        return Math.max(-1, Math.min(1, score));
    }

    // ==================== TECHNICAL ANALYSIS ====================
    function calculateIndicators() {
        if (state.priceHistory.length < 30) return null;
        
        const prices = state.priceHistory.map(h => h.price);
        const closes = prices;
        
        // RSI
        const rsi = calculateRSI(closes, 14);
        
        // MACD
        const macd = calculateMACD(closes);
        
        // EMA
        const ema20 = calculateEMA(prices, 20);
        const ema50 = prices.length >= 50 ? calculateEMA(prices, 50) : null;
        
        // ATR
        const atr = calculateATR(prices, 14);
        
        // –£—Ä–æ–≤–Ω–∏
        const support = Math.min(...prices.slice(-20));
        const resistance = Math.max(...prices.slice(-20));
        
        // –¢—Ä–µ–Ω–¥
        const trend = ema50 ? (ema20 > ema50 ? 'bullish' : 'bearish') : 'neutral';
        
        state.indicators = {
            rsi, macd, ema20, ema50, atr, support, resistance, trend,
            currentPrice: prices[prices.length - 1]
        };
        
        updateIndicatorsUI();
        return state.indicators;
    }

    function calculateRSI(prices, period) {
        if (prices.length < period + 1) return 50;
        
        let gains = 0, losses = 0;
        
        for (let i = prices.length - period; i < prices.length; i++) {
            const change = prices[i] - prices[i-1];
            if (change > 0) gains += change;
            else losses -= change;
        }
        
        const avgGain = gains / period;
        const avgLoss = losses / period;
        
        if (avgLoss === 0) return 100;
        const rs = avgGain / avgLoss;
        return 100 - (100 / (1 + rs));
    }

    function calculateMACD(prices) {
        const ema12 = calculateEMA(prices, 12);
        const ema26 = calculateEMA(prices, 26);
        const macdLine = ema12 - ema26;
        const signal = calculateEMA([...Array(8).fill(macdLine), macdLine], 9);
        
        return {
            macd: macdLine,
            signal: signal,
            histogram: macdLine - signal,
            signalStrength: Math.abs(macdLine - signal)
        };
    }

    function calculateEMA(prices, period) {
        const k = 2 / (period + 1);
        let ema = prices[0];
        for (let i = 1; i < prices.length; i++) {
            ema = prices[i] * k + ema * (1 - k);
        }
        return ema;
    }

    function calculateATR(prices, period) {
        const recent = prices.slice(-period);
        let sum = 0;
        for (let i = 1; i < recent.length; i++) {
            sum += Math.abs(recent[i] - recent[i-1]);
        }
        return sum / (period - 1);
    }

    // ==================== AI ANALYSIS ====================
    async function performAIAnalysis() {
        if (!state.apiKey) {
            log('AI Analysis skipped: No API key', 'warning');
            return;
        }
        
        if (!state.currentPrice || state.priceHistory.length < 30) {
            log('AI Analysis skipped: Insufficient data', 'warning');
            return;
        }
        
        const btn = document.getElementById('analyze-btn');
        btn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚ö°</span> Analyzing...';
        btn.disabled = true;
        
        try {
            log('Sending market data to DeepSeek-v3.2...', 'ai');
            
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è AI
            const currentPrice = state.currentPrice;
            const prevPrice = state.previousPrice || currentPrice;
            const priceChange = ((currentPrice - prevPrice) / prevPrice * 100).toFixed(2);
            
            const ind = state.indicators;
            const recentPrices = state.priceHistory.slice(-20).map(h => h.price.toFixed(4));
            
            // –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ—Å—Ç–µ–π
            const newsContext = state.news.slice(0, 5).map(n => 
                `- ${n.title} [${n.source}, ${n.sentiment > 0 ? 'Positive' : n.sentiment < 0 ? 'Negative' : 'Neutral'}]`
            ).join('\n');
            
            const avgSentiment = state.news.reduce((sum, n) => sum + (n.sentiment || 0), 0) / (state.news.length || 1);
            
            const prompt = `You are an expert FOREX analyst specializing in USD/RUB pair. Analyze the following real-time market data and provide a trading signal.

=== MARKET DATA ===
Current Price: ${currentPrice.toFixed(4)} RUB
24h Change: ${priceChange}%
Day Open: ${state.dayOpen?.toFixed(4) || 'N/A'}
Day High: ${state.dayHigh?.toFixed(4) || 'N/A'}
Day Low: ${state.dayLow?.toFixed(4) || 'N/A'}

=== TECHNICAL INDICATORS ===
RSI (14): ${ind?.rsi?.toFixed(2) || 'N/A'}
MACD Histogram: ${ind?.macd?.histogram?.toFixed(4) || 'N/A'}
EMA 20: ${ind?.ema20?.toFixed(4) || 'N/A'}
ATR (14): ${ind?.atr?.toFixed(4) || 'N/A'}
Support: ${ind?.support?.toFixed(4) || 'N/A'}
Resistance: ${ind?.resistance?.toFixed(4) || 'N/A'}
Trend: ${ind?.trend || 'N/A'}

=== NEWS SENTIMENT ===
Average Sentiment Score: ${avgSentiment.toFixed(2)} (-1 bearish to +1 bullish)
Recent Headlines:
${newsContext}

=== PRICE ACTION (Last 20 periods) ===
${JSON.stringify(recentPrices)}

Provide your response in this exact JSON format:
{
  "signal": "BUY" or "SELL" or "HOLD",
  "confidence": 0-100,
  "technical_score": 0-100,
  "news_score": -100 to 100,
  "trend_score": 0-100,
  "reasoning": "Detailed analysis in Russian. Explain technical levels, news impact, and risk factors. 2-3 sentences.",
  "entry": number,
  "stop_loss": number,
  "take_profit": number,
  "risk_reward": "1:X"
}

Rules:
- BUY = expecting RUB to strengthen (USD/RUB down) or good entry to buy USD
- SELL = expecting RUB to weaken (USD/RUB up) or good entry to sell USD  
- Confidence >80 requires strong confluence of technical + news
- Include specific price levels based on support/resistance
- Consider Russian market specifics: CBR interventions, oil correlation, sanctions risk`;

            const response = await fetch(CONFIG.openrouter.url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': CONFIG.openrouter.siteUrl,
                    'X-Title': CONFIG.openrouter.siteName
                },
                body: JSON.stringify({
                    model: CONFIG.openrouter.model,
                    messages: [
                        { 
                            role: 'system', 
                            content: 'You are a professional FOREX analyst for USD/RUB. Respond only in valid JSON. Be precise with numbers.' 
                        },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.2,
                    max_tokens: 800
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API Error ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            const content = data.choices[0].message.content;
            
            // Extract JSON
            let result;
            try {
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                result = JSON.parse(jsonMatch ? jsonMatch[0] : content);
            } catch (e) {
                console.error('Parse error:', content);
                throw new Error('Failed to parse AI response');
            }
            
            updateAISignal(result);
            log(`AI Signal: ${result.signal} @ ${result.confidence}% confidence`, 'success');
            
        } catch (error) {
            log('AI Analysis failed: ' + error.message, 'error');
            console.error(error);
            
            // Fallback analysis if AI fails
            const fallback = generateFallbackAnalysis();
            updateAISignal(fallback);
        } finally {
            btn.innerHTML = 'Analyze Now';
            btn.disabled = false;
        }
    }

    // Fallback –µ—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
    function generateFallbackAnalysis() {
        const ind = state.indicators;
        if (!ind) return { signal: 'HOLD', confidence: 50, reasoning: 'Insufficient data' };
        
        let score = 50;
        let signal = 'HOLD';
        
        // Technical rules
        if (ind.rsi < 30) score += 20;
        if (ind.rsi > 70) score -= 20;
        if (ind.macd.histogram > 0) score += 15;
        if (ind.macd.histogram < 0) score -= 15;
        
        // News impact
        const newsImpact = state.news.reduce((sum, n) => sum + (n.sentiment || 0), 0) / (state.news.length || 1);
        score += newsImpact * 30;
        
        if (score > 70) signal = 'BUY';
        else if (score < 30) signal = 'SELL';
        
        return {
            signal: signal,
            confidence: Math.abs(score - 50) * 2,
            technical_score: score,
            news_score: newsImpact * 100,
            trend_score: ind.trend === 'bullish' ? 70 : 30,
            reasoning: `Fallback analysis: RSI ${ind.rsi.toFixed(1)}, MACD ${ind.macd.histogram > 0 ? 'bullish' : 'bearish'}, News sentiment ${newsImpact > 0 ? 'positive' : 'negative'}.`,
            entry: ind.currentPrice,
            stop_loss: ind.currentPrice * (signal === 'BUY' ? 0.98 : 1.02),
            take_profit: ind.currentPrice * (signal === 'BUY' ? 1.03 : 0.97),
            risk_reward: '1:1.5'
        };
    }

    // ==================== UI UPDATES ====================
    function updatePriceDisplay(data) {
        if (!data || !data.price) return;
        
        const price = parseFloat(data.price);
        state.currentPrice = price;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ high/low –¥–Ω—è
        if (!state.dayHigh || price > state.dayHigh) state.dayHigh = price;
        if (!state.dayLow || price < state.dayLow) state.dayLow = price;
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        state.priceHistory.push({
            time: new Date(),
            price: price,
            source: data.source
        });
        
        if (state.priceHistory.length > CONFIG.settings.maxHistoryPoints) {
            state.priceHistory.shift();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        const priceEl = document.getElementById('main-price');
        const oldPrice = parseFloat(priceEl.textContent) || 0;
        priceEl.textContent = price.toFixed(4);
        
        if (price > oldPrice) priceEl.style.color = 'var(--accent-sell)'; // USD up = red for RUB
        else if (price < oldPrice) priceEl.style.color = 'var(--accent-buy)';
        
        // Change
        if (state.previousPrice) {
            const change = ((price - state.previousPrice) / state.previousPrice * 100);
            const changeEl = document.getElementById('main-change');
            changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            changeEl.className = 'price-change ' + (change >= 0 ? 'positive' : 'negative');
            changeEl.style.background = change >= 0 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)';
            changeEl.style.color = change >= 0 ? 'var(--accent-sell)' : 'var(--accent-buy)';
        }
        
        // Stats
        document.getElementById('stat-open').textContent = state.dayOpen?.toFixed(4) || '--';
        document.getElementById('stat-high').textContent = state.dayHigh?.toFixed(4) || '--';
        document.getElementById('stat-low').textContent = state.dayLow?.toFixed(4) || '--';
        document.getElementById('stat-prev').textContent = state.previousPrice?.toFixed(4) || '--';
        document.getElementById('stat-time').textContent = new Date().toLocaleTimeString();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        updateChart();
        
        // –†–∞—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
        calculateIndicators();
    }

    function updateIndicatorsUI() {
        const ind = state.indicators;
        if (!ind) return;
        
        const cards = document.querySelectorAll('.indicator-card');
        
        // RSI
        cards[0].querySelector('.indicator-value').textContent = ind.rsi.toFixed(1);
        cards[0].querySelector('.indicator-value').style.color = 
            ind.rsi > 70 ? 'var(--accent-sell)' : ind.rsi < 30 ? 'var(--accent-buy)' : 'var(--text-primary)';
        cards[0].querySelector('.indicator-delta').textContent = 
            ind.rsi > 70 ? 'Overbought' : ind.rsi < 30 ? 'Oversold' : 'Neutral';
        cards[0].querySelector('.indicator-delta').style.color = 
            ind.rsi > 70 || ind.rsi < 30 ? 'var(--accent-hold)' : 'var(--text-secondary)';
        
        // MACD
        cards[1].querySelector('.indicator-value').textContent = ind.macd.histogram > 0 ? 'BULL' : 'BEAR';
        cards[1].querySelector('.indicator-value').style.color = 
            ind.macd.histogram > 0 ? 'var(--accent-buy)' : 'var(--accent-sell)';
        cards[1].querySelector('.indicator-delta').textContent = 
            Math.abs(ind.macd.histogram).toFixed(4);
        
        // EMA
        cards[2].querySelector('.indicator-value').textContent = ind.ema20.toFixed(4);
        cards[2].querySelector('.indicator-delta').textContent = 
            ind.currentPrice > ind.ema20 ? 'Above' : 'Below';
        cards[2].querySelector('.indicator-delta').style.color = 
            ind.currentPrice > ind.ema20 ? 'var(--accent-buy)' : 'var(--accent-sell)';
        
        // ATR
        cards[3].querySelector('.indicator-value').textContent = ind.atr.toFixed(4);
        cards[3].querySelector('.indicator-delta').textContent = 
            (ind.atr / ind.currentPrice * 100).toFixed(2) + '%';
    }

    function updateAISignal(result) {
        const box = document.getElementById('ai-signal-box');
        const text = document.getElementById('ai-signal');
        const fill = document.getElementById('confidence-fill');
        const confText = document.getElementById('confidence-text');
        const reasoning = document.getElementById('ai-reasoning');
        const lastAnalysis = document.getElementById('last-analysis');
        
        // Update details
        document.getElementById('tech-score').textContent = result.technical_score ? result.technical_score + '%' : '--';
        document.getElementById('news-score').textContent = result.news_score ? result.news_score.toFixed(0) : '--';
        document.getElementById('trend-score').textContent = result.trend_score ? result.trend_score + '%' : '--';
        document.getElementById('suggested-entry').textContent = result.entry ? result.entry.toFixed(4) : '--';
        
        // Signal box
        box.className = 'signal-box';
        text.textContent = result.signal;
        confText.textContent = result.confidence + '%';
        fill.style.width = result.confidence + '%';
        reasoning.textContent = result.reasoning;
        lastAnalysis.textContent = 'Last: ' + new Date().toLocaleTimeString();
        
        if (result.signal === 'BUY') {
            box.classList.add('signal-buy');
            fill.style.background = 'var(--accent-buy)';
        } else if (result.signal === 'SELL') {
            box.classList.add('signal-sell');
            fill.style.background = 'var(--accent-sell)';
        } else {
            box.classList.add('signal-hold');
            fill.style.background = 'var(--accent-hold)';
        }
        
        state.lastAnalysis = result;
    }

    function updateNewsFeed() {
        const container = document.getElementById('news-feed');
        
        if (state.news.length === 0) {
            container.innerHTML = '<div class="news-item"><div class="news-title">No news available</div></div>';
            return;
        }
        
        container.innerHTML = state.news.map(item => {
            const timeDiff = Math.floor((new Date() - item.time) / 60000);
            const timeStr = timeDiff < 60 ? timeDiff + ' min ago' : 
                           timeDiff < 1440 ? Math.floor(timeDiff/60) + ' hours ago' : 
                           Math.floor(timeDiff/1440) + ' days ago';
            
            const impactClass = item.impact === 'high' ? 'impact-high' : 
                               item.impact === 'medium' ? 'impact-medium' : 'impact-low';
            
            const sentimentColor = item.sentiment > 0.2 ? 'var(--accent-buy)' : 
                                  item.sentiment < -0.2 ? 'var(--accent-sell)' : 'var(--accent-hold)';
            
            return `
                <div class="news-item" onclick="window.open('${item.url || '#'}', '_blank')">
                    <div class="news-header">
                        <span class="news-source">${item.source}</span>
                        <span class="news-time">${timeStr}</span>
                    </div>
                    <div class="news-title">${item.title}</div>
                    <div class="news-impact">
                        <span class="impact-badge ${impactClass}">${item.impact || 'low'}</span>
                        <div class="sentiment-bar">
                            <div class="sentiment-fill" style="width: ${(item.sentiment + 1) * 50}%; background: ${sentimentColor};"></div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateDataStatus(source, active) {
        state.dataStatus[source] = active;
        const dot = document.getElementById(source + '-status');
        const text = document.getElementById(source + '-text');
        const sourceEl = document.getElementById('source-' + source);
        
        if (dot) {
            dot.className = 'status-dot ' + (active ? 'active' : '');
        }
        if (text) {
            text.textContent = active ? 'Active' : 'Error';
        }
        if (sourceEl) {
            sourceEl.className = 'source-status ' + (active ? 'active' : '');
            sourceEl.textContent = active ? 'Active' : 'Error';
        }
    }

    function updateChart() {
        if (!state.chart) return;
        
        const data = state.priceHistory.slice(-100);
        
        state.chart.data.datasets[0].data = data.map(h => ({
            x: h.time,
            y: h.price
        }));
        
        if (state.indicators.ema20) {
            state.chart.data.datasets[1].data = data.map(() => ({
                x: data[0].time, // Will be overridden per point
                y: state.indicators.ema20
            }));
            // Fix EMA line to use actual times
            state.chart.data.datasets[1].data = data.map(h => ({
                x: h.time,
                y: state.indicators.ema20
            }));
        }
        
        state.chart.update('none');
    }

    // ==================== CHART ====================
    function initChart() {
        const ctx = document.getElementById('tradingChart').getContext('2d');
        
        state.chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'USD/RUB',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: (ctx) => {
                        const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 400);
                        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
                        gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');
                        return gradient;
                    },
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 6
                }, {
                    label: 'EMA 20',
                    data: [],
                    borderColor: '#f59e0b',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        labels: { color: '#9ca3af', font: { family: 'JetBrains Mono' } }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#9ca3af',
                        borderColor: '#374151',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(4) + ' RUB';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm',
                                hour: 'HH:mm'
                            }
                        },
                        grid: { color: '#374151', drawBorder: false },
                        ticks: { color: '#9ca3af', maxTicksLimit: 6, font: { family: 'JetBrains Mono' } }
                    },
                    y: {
                        grid: { color: '#374151', drawBorder: false },
                        ticks: { 
                            color: '#9ca3af',
                            callback: function(value) {
                                return value.toFixed(2);
                            },
                            font: { family: 'JetBrains Mono' }
                        }
                    }
                }
            }
        });
    }

    // ==================== CONTROLS ====================
    function validateApiKey() {
        const key = document.getElementById('openrouter-key').value.trim();
        if (!key || !key.startsWith('sk-or-')) {
            log('Invalid API key format. Must start with sk-or-', 'error');
            return;
        }
        
        state.apiKey = key;
        state.aiConnected = true;
        updateDataStatus('ai', true);
        log('OpenRouter API key validated', 'success');
        document.getElementById('analyze-btn').disabled = false;
        
        // Immediate analysis
        setTimeout(performAIAnalysis, 1000);
        
        // Auto analysis
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                performAIAnalysis();
            }
        }, CONFIG.settings.analysisInterval);
    }

    function forceAnalysis() {
        performAIAnalysis();
    }

    function updateSettings(type, value) {
        if (type === 'interval') {
            CONFIG.settings.analysisInterval = value * 1000;
            document.getElementById('interval-value').textContent = value + 's';
        } else if (type === 'newsWeight') {
            CONFIG.settings.newsWeight = parseInt(value);
            document.getElementById('news-weight-value').textContent = value + '%';
        } else if (type === 'threshold') {
            CONFIG.settings.confidenceThreshold = parseInt(value);
            document.getElementById('threshold-value').textContent = value + '%';
        }
    }

    function simulateTrade(type) {
        const amount = parseFloat(document.getElementById('trade-amount').value) || 1000;
        const price = state.currentPrice;
        
        if (!price) {
            log('Cannot trade: No price data', 'error');
            return;
        }
        
        const position = {
            id: Date.now(),
            type: type,
            amount: amount,
            entryPrice: price,
            time: new Date(),
            pnl: 0
        };
        
        state.positions.push(position);
        updatePositions();
        log(`Opened ${type.toUpperCase()} position: ${amount} USD @ ${price.toFixed(4)}`, 'success');
    }

    function updatePositions() {
        const container = document.getElementById('positions-list');
        
        if (state.positions.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 30px;">No open positions</div>';
            return;
        }
        
        const currentPrice = state.currentPrice || 0;
        
        container.innerHTML = state.positions.map(pos => {
            const pnl = pos.type === 'buy' ? 
                (currentPrice - pos.entryPrice) / pos.entryPrice * 100 :
                (pos.entryPrice - currentPrice) / pos.entryPrice * 100;
            
            const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
            
            return `
                <div class="position-card">
                    <div class="position-info">
                        <span class="position-type ${pos.type}">${pos.type.toUpperCase()}</span>
                        <span class="position-price">${pos.amount} USD @ ${pos.entryPrice.toFixed(4)}</span>
                    </div>
                    <div class="position-pnl">
                        <div class="pnl-value ${pnlClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}%</div>
                        <div class="pnl-label">Unrealized P&L</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function log(message, type = 'info') {
        const container = document.getElementById('system-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry ' + type;
        
        const time = new Date().toLocaleTimeString('ru-RU', { hour12: false });
        entry.innerHTML = `
            <span class="log-time">${time}</span>
            <span class="log-message">${message}</span>
        `;
        
        container.insertBefore(entry, container.firstChild);
        
        while (container.children.length > 100) {
            container.removeChild(container.lastChild);
        }
    }

    // ==================== MAIN LOOP ====================
    async function updateData() {
        // Fetch CBRF (—Ä–∞–∑ –≤ 5 –º–∏–Ω—É—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∫—É—Ä—Å –º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ)
        const cbrfData = await fetchCBRF();
        if (cbrfData) {
            updatePriceDisplay(cbrfData);
        }
        
        // Fetch MOEX (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏)
        const moexData = await fetchMOEX();
        if (moexData) {
            updatePriceDisplay(moexData);
        }
        
        // Fetch News (–∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç)
        if (state.news.length === 0 || (Date.now() - state.news[0].time > 600000)) {
            await fetchNews();
        }
    }

    // ==================== INIT ====================
    window.addEventListener('DOMContentLoaded', async () => {
        initChart();
        log('USD/RUB Terminal initialized', 'info');
        log('Connecting to CBRF and MOEX...', 'info');
        
        // Initial data fetch
        await updateData();
        
        // Regular updates
        setInterval(updateData, 30000); // –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        
        // Chart update optimization
        setInterval(() => {
            if (state.chart) state.chart.update('none');
        }, 1000);
    });

    // Error handling
    window.addEventListener('error', (e) => {
        log('System error: ' + e.message, 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
        log('Async error: ' + e.reason, 'error');
    });
</script>

</body>
</html>

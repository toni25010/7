<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si AI Terminal | Live Realtime</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --text: #c9d1d9; --accent: #8957e5; --buy: #238636; --sell: #f85149; --hold: #d29922; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 12px; min-height: 100vh; }
        h2 { text-align: center; font-size: clamp(1.1rem, 4vw, 1.6rem); margin: 0 0 12px 0; }
        .grid { display: grid; grid-template-columns: 2.2fr 1fr; gap: 16px; max-width: 1600px; margin: 0 auto; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        #chart { height: 400px; width: 100%; position: relative; background: var(--card); border-radius: 12px; overflow: hidden; }
        .tf-selector { display: flex; gap: 6px; margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tf-btn { background: transparent; color: var(--text); border: 1px solid transparent; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; opacity: 0.6; }
        .tf-btn.active { background: var(--accent); color: white; opacity: 1; }
        
        .ticker-wrap { display: flex; justify-content: space-between; background: #0d1117; padding: 12px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border); }
        .ticker-val { font-size: 24px; font-weight: 700; font-family: 'Courier New'; }
        .ticker-label { font-size: 10px; color: #8b949e; margin-bottom: 2px; }
        
        .signal-display { text-align: center; padding: 12px; border-radius: 16px; border: 2px solid var(--border); margin-bottom: 12px; transition: 0.3s; }
        .signal-display.buy { border-color: var(--buy); color: #3fb950; background: rgba(35, 134, 54, 0.1); }
        .signal-display.sell { border-color: var(--sell); color: var(--sell); background: rgba(248, 81, 73, 0.1); }
        .signal-display.hold { border-color: var(--hold); color: var(--hold); background: rgba(210, 153, 34, 0.1); }
        
        .trade-plan-box { margin-top: 10px; background: #0d1117; border-radius: 12px; padding: 10px; border: 1px solid var(--border); display: none; }
        .plan-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .plan-row:last-child { border-bottom: none; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        
        .news-box { margin-top: 12px; max-height: 180px; overflow-y: auto; font-size: 12px; }
        .news-item { padding: 8px; border-left: 2px solid var(--accent); margin-bottom: 6px; background: rgba(255,255,255,0.02); }
        .news-time { color: #58a6ff; font-size: 10px; font-weight: 600; margin-bottom: 2px; display: block; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 10px; }
        .stat-item { background: #0d1117; padding: 8px; border-radius: 6px; font-size: 12px; border: 1px solid var(--border); }
        
        button { background: var(--accent); color: white; border: none; padding: 12px 16px; cursor: pointer; border-radius: 12px; width: 100%; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.small { background: #21262d; width: auto; padding: 8px 12px; margin-top: 0; font-size: 12px; }
        
        input { width: 100%; padding: 10px; background: #0d1117; color: white; border: 1px solid var(--border); border-radius: 10px; margin-top: 6px; font-size: 14px; }
        
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 10px 20px; border-radius: 30px; border: 1px solid var(--border); z-index: 100; font-size: 12px; display: flex; align-items: center; gap: 8px; }
        .spinner { width: 12px; height: 12px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: var(--sell); font-size: 12px; text-align: center; margin-top: 10px; }

        @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h2>Si AI Terminal | Realtime Chart</h2>

    <div class="grid">
        <!-- LEFT -->
        <div class="card">
            <div class="tf-selector" id="tfSelector">
                <button class="tf-btn active" data-tf="15" type="button">15M</button>
                <button class="tf-btn" data-tf="60" type="button">1H</button>
                <button class="tf-btn" data-tf="1440" type="button">1D</button>
            </div>
            
            <div id="chart"><div id="loading"><div class="spinner"></div> Загрузка...</div></div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 6px; padding: 0 4px; font-size: 11px; color: #8b949e;">
                <span id="contractName">Контракт: --</span>
                <span id="lastTradeTime">--</span>
            </div>

            <div class="news-box" id="newsBox">
                <div style="font-weight: 600; color: var(--accent); margin-bottom: 8px;">Новости</div>
                <div id="newsList">Загрузка...</div>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
            <div class="ticker-wrap">
                <div style="text-align: left;">
                    <div class="ticker-label">ПОСЛЕДНЯЯ ЦЕНА</div>
                    <div class="ticker-val" id="currentPrice">--</div>
                </div>
                <div style="text-align: right;">
                    <div class="ticker-label">ИЗМЕНЕНИЕ</div>
                    <div class="ticker-val" id="changePercent">--</div>
                </div>
            </div>

            <div id="signal_ui" class="signal-display hold">
                <div style="font-size: 10px; opacity: 0.7;">СИГНАЛ</div>
                <div id="signal_text" style="font-size: 24px; font-weight: bold;">ОЖИДАНИЕ</div>
                <div id="signal_confidence" style="font-size: 11px; margin-top: 2px;"></div>
            </div>

            <div id="tradePlanBox" class="trade-plan-box">
                <div style="text-align: center; font-size: 11px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">ТОРГОВЫЙ ПЛАН</div>
                <div class="plan-row"><span><span class="dot" style="background: #58a6ff;"></span>Entry</span><span id="aiEntry" style="color: #58a6ff">--</span></div>
                <div class="plan-row"><span><span class="dot" style="background: var(--buy);"></span>TP</span><span id="aiTP" style="color: var(--buy)">--</span></div>
                <div class="plan-row"><span><span class="dot" style="background: var(--sell);"></span>SL</span><span id="aiSL" style="color: var(--sell)">--</span></div>
            </div>

            <div id="ai_desc" class="error-msg" style="display:none;"></div>

            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-item"><div style="color: #8b949e; font-size: 10px;">RSI</div><div id="statRsi" style="font-weight: 600;">-</div></div>
                <div class="stat-item"><div style="color: #8b949e; font-size: 10px;">ATR</div><div id="statAtr" style="font-weight: 600;">-</div></div>
                <div class="stat-item"><div style="color: #8b949e; font-size: 10px;">MACD</div><div id="statMacd" style="font-weight: 600;">-</div></div>
                <div class="stat-item"><div style="color: #8b949e; font-size: 10px;">Тренд</div><div id="statTrend" style="font-weight: 600;">-</div></div>
            </div>

            <button onclick="runAnalysis()" type="button"> КОМПЛЕКСНЫЙ АНАЛИЗ</button>

            <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border);">
                <label style="font-size: 11px;">API Key:</label>
                <input type="password" id="api_key_input" placeholder="sk-or-..." value="">
                <button class="small" onclick="saveKey()" style="margin-top: 4px; width: 100%;">Сохранить</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIG ==================
        const MOEX_BASE = "https://iss.moex.com/iss/engines/futures/markets/forts";
        
        let currentTicker = null;
        let chart = null;
        let candleSeries = null;
        let priceLines = [];
        let historyData = [];
        let allNews = [];
        let currentTf = 15; // Timeframe in minutes

        // ==================== 1. SMART TICKER ====================
        const antiCache = () => `_=${Date.now()}`;

        async function detectActiveContract() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            loading.innerHTML = '<div class="spinner"></div> Поиск актива...';
            
            const url = `${MOEX_BASE}/securities.json?q=Si&iss.only=marketdata,securities&${antiCache()}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const cols = data.marketdata.columns;
                const rows = data.marketdata.data;
                
                let best = { ticker: 'SiH6', vol: 0 };
                const idxVol = cols.indexOf('VALTODAY');
                const secCols = data.securities.columns;
                const secRows = data.securities.data;
                const idxSecId = secCols.indexOf('SECID');

                rows.forEach((row, i) => {
                    const secId = secRows[i] ? secRows[i][idxSecId] : '';
                    if (!secId.startsWith('Si')) return;
                    const vol = row[idxVol] || 0;
                    if (vol > best.vol) best = { ticker: secId, vol: vol };
                });

                currentTicker = best.ticker;
                document.getElementById('contractName').innerText = `Контракт: ${currentTicker}`;
                return true;
            } catch(e) {
                currentTicker = "SiH6";
                return false;
            }
        }

        // ==================== 2. DATA (UNTOUCHED CORE) ==================
        async function fetchQuotes() {
            if(!currentTicker) return;
            const url = `${MOEX_BASE}/securities/${currentTicker}.json?iss.only=marketdata&${antiCache()}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const cols = data.marketdata.columns;
                const row = data.marketdata.data[0];
                if(!row) return;
                
                const idx = { last: cols.indexOf('LAST'), chg: cols.indexOf('CHANGE'), time: cols.indexOf('SYSTIME'), prev: cols.indexOf('PREVPRICE') };
                
                const quote = {
                    price: row[idx.last],
                    change: row[idx.chg],
                    prev: row[idx.prev],
                    time: row[idx.time]
                };
                
                updatePriceUI(quote);
                
                // === NEW: REALTIME CHART UPDATE ===
                if(quote.price) updateChartLive(quote.price);
                // ==================================

            } catch(e) { console.error("Quote error", e); }
        }

        async function fetchCandles(tf = 15) {
            if(!currentTicker) return;
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            const d = new Date();
            d.setDate(d.getDate() - 7);
            const from = d.toISOString().split('T')[0];
            
            const url = `${MOEX_BASE}/securities/${currentTicker}/candles.json?interval=${tf}&from=${from}&${antiCache()}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (!data.candles?.data?.length) throw new Error("Нет свечей");

                const cols = data.candles.columns;
                const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), t: cols.indexOf('begin') };

                historyData = data.candles.data.map(r => ({
                    time: Math.floor(new Date(r[idx.t]).getTime() / 1000),
                    open: r[idx.o], high: r[idx.h], low: r[idx.l], close: r[idx.c]
                })).filter(c => c.close > 0);

                renderChart(historyData);
            } catch(e) {
                loading.innerHTML = `<span style='color:var(--sell); font-size:12px;'>Ошибка: ${e.message}</span>`;
            }
            loading.style.display = 'none';
        }

        async function fetchNews() {
            const list = document.getElementById('newsList');
            const query = encodeURIComponent('ЦБ РФ OR Brent OR Курс доллара');
            const rss = `https://news.google.com/rss/search?q=${query}&hl=ru&gl=RU&ceid=RU:ru`;
            const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rss)}&count=8`;

            try {
                const res = await fetch(api);
                const data = await res.json();
                if(data.status !== 'ok') throw new Error();
                
                const now = new Date();
                allNews = data.items.filter(n => ((now - new Date(n.pubDate))/3600000) < 48).slice(0, 5);
                if(allNews.length === 0) allNews = data.items.slice(0, 3);

                list.innerHTML = allNews.map(n => {
                    const hrs = Math.round((now - new Date(n.pubDate))/3600000);
                    return `<div class="news-item"><span class="news-time">${hrs}ч назад</span><a href="${n.link}" target="_blank" style="color:var(--text);text-decoration:none;">${n.title}</a></div>`;
                }).join('');
            } catch(e) {
                list.innerHTML = "<div style='color:var(--sell)'>Ошибка новостей</div>";
            }
        }

        // ==================== 3. REALTIME CHART LOGIC ==================
        function updateChartLive(price) {
            if (!candleSeries || !historyData.length) return;

            const now = Math.floor(Date.now() / 1000);
            // Вычисляем время начала текущей свечи (Timeframe Alignment)
            const tfSeconds = currentTf * 60;
            const currentCandleTime = Math.floor(now / tfSeconds) * tfSeconds;

            // Берем последнюю свечу из истории
            let lastCandle = historyData[historyData.length - 1];

            // Если время совпадает (мы внутри той же свечи) - обновляем
            if (lastCandle.time === currentCandleTime) {
                lastCandle.close = price;
                if (price > lastCandle.high) lastCandle.high = price;
                if (price < lastCandle.low) lastCandle.low = price;
            } else {
                // Если время новое (началась новая свеча) - создаем
                const newCandle = {
                    time: currentCandleTime,
                    open: lastCandle.close, // Открытие = закрытие предыдущей
                    high: price,
                    low: price,
                    close: price
                };
                historyData.push(newCandle);
                // Удаляем старую, если слишком много
                if (historyData.length > 500) historyData.shift();
            }

            // Обновляем серию данных (рефреш только последней точки)
            candleSeries.update(historyData[historyData.length - 1]);
        }

        // ==================== 4. CHART RENDER ==================
        function renderChart(data) {
            const cont = document.getElementById('chart');
            cont.innerHTML = '';
            priceLines = [];

            chart = LightweightCharts.createChart(cont, {
                layout: { background: { color: '#161b22' }, textColor: '#8b949e' },
                grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
                timeScale: { timeVisible: true },
                width: cont.clientWidth, height: 400
            });
            candleSeries = chart.addCandlestickSeries({ upColor: '#238636', downColor: '#f85149', borderVisible: false });
            candleSeries.setData(data);
            chart.timeScale().fitContent();
        }

        function drawPlan(e, tp, sl) {
            if(!candleSeries) return;
            priceLines.forEach(l => candleSeries.removePriceLine(l));
            priceLines = [];
            const mkLine = (p, c, t) => candleSeries.createPriceLine({ price: p, color: c, lineWidth: 2, lineStyle: 1, title: t });
            priceLines.push(mkLine(e, '#58a6ff', 'Entry'));
            priceLines.push(mkLine(tp, '#238636', 'TP'));
            priceLines.push(mkLine(sl, '#f85149', 'SL'));
        }

        // ==================== 5. UI ==================
        function updatePriceUI(q) {
            if(!q || !q.price) return;
            document.getElementById('currentPrice').innerText = q.price.toFixed(2);
            if(q.prev > 0) {
                const pct = ((q.price - q.prev)/q.prev * 100);
                document.getElementById('changePercent').innerText = (pct>=0?'+':'') + pct.toFixed(2)+'%';
                document.getElementById('changePercent').style.color = pct>=0?'var(--buy)':'var(--sell)';
            }
            if(q.time) document.getElementById('lastTradeTime').innerText = "Сделка: " + new Date(q.time).toLocaleTimeString('ru-RU');
        }

        // ==================== 6. ANALYSIS ==================
        function calcTech() {
            if (historyData.length < 20) return null;
            
            const c = historyData.map(d=>d.close);
            let g=0,l=0;
            for(let i=c.length-14;i<c.length;i++){ const d=c[i]-c[i-1]; if(d>0)g+=d; else l-=d; }
            const rsi = l===0 ? 100 : 100 - (100/(1+g/l));
            const ema = (p,per) => p.slice(1).reduce((e,v)=>v*(2/(per+1))+e*(1-2/(per+1)), p[0]);
            const macd = ema(c,12)-ema(c,26);
            let tr=0;
            for(let i=historyData.length-14;i<historyData.length;i++){ const h=historyData[i].high, l=historyData[i].low, pc=historyData[i-1].close; tr+=Math.max(h-l, Math.abs(h-pc), Math.abs(l-pc)); }
            const atr = tr/14;

            document.getElementById('statsGrid').style.display='grid';
            document.getElementById('statRsi').innerText=rsi.toFixed(1);
            document.getElementById('statAtr').innerText=atr.toFixed(2);
            document.getElementById('statMacd').innerText=macd.toFixed(2);
            document.getElementById('statMacd').style.color=macd>0?'var(--buy)':'var(--sell)';
            document.getElementById('statTrend').innerText=c[c.length-1]>ema(c,20)?'BULL':'BEAR';

            return {rsi, atr, macd, price:c[c.length-1], trend: c[c.length-1]>ema(c,20)?'BULL':'BEAR'};
        }

        async function runAnalysis() {
            const key = document.getElementById('api_key_input').value.trim();
            if(!key) { alert("Введите API Key"); return; }
            
            const tech = calcTech();
            if (!tech) { alert("Недостаточно данных."); return; }

            document.getElementById('signal_text').innerText = "АНАЛИЗ...";
            document.getElementById('tradePlanBox').style.display = 'none';
            document.getElementById('ai_desc').style.display = 'none';

            let newsStr = "НОВОСТИ:\n";
            if(allNews.length > 0) allNews.forEach((n,i)=>newsStr+=`${i+1}. ${n.title}\n`);

            const prompt = `Ты трейдер Si.
Цена: ${tech.price.toFixed(2)}
RSI: ${tech.rsi.toFixed(1)}
MACD: ${tech.macd.toFixed(2)}
ATR: ${tech.atr.toFixed(2)}

 ${newsStr}

Сигнал: ПОКУПКА/ПРОДАЖА/ДЕРЖАТЬ.
План (ATR):
BUY: TP=Price+1.5*ATR, SL=Price-1*ATR.
SELL: TP=Price-1.5*ATR, SL=Price+1*ATR.
JSON: { "signal":"...", "confidence":80, "entry":0, "tp":0, "sl":0, "reason":"..." }`;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "deepseek/deepseek-v3.2", messages: [{role:"user", content:prompt}] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                const json = parse(data.choices[0].message.content);
                updateUI(json, tech.price);
            } catch(e) {
                document.getElementById('signal_text').innerText = "ОШИБКА";
                document.getElementById('ai_desc').innerText = e.message;
                document.getElementById('ai_desc').style.display = 'block';
            }
        }

        function parse(s) { try { return JSON.parse(s.match(/\{[\s\S]*\}/)[0]); } catch { return {signal:"ДЕРЖАТЬ", confidence:0, reason:"err", entry:0,tp:0,sl:0}; } }

        function updateUI(j, p) {
            const ui = document.getElementById('signal_ui');
            ui.className = "signal-display " + (j.signal==='ПОКУПКА'?'buy':j.signal==='ПРОДАЖА'?'sell':'hold');
            document.getElementById('signal_text').innerText = j.signal;
            document.getElementById('signal_confidence').innerText = `Уверенность: ${j.confidence}%`;
            document.getElementById('ai_desc').innerText = j.reason;
            document.getElementById('ai_desc').style.display = 'block';
            
            if(j.entry && j.tp && j.sl && !isNaN(j.entry)) {
                document.getElementById('tradePlanBox').style.display='block';
                document.getElementById('aiEntry').innerText=j.entry.toFixed(2);
                document.getElementById('aiTP').innerText=j.tp.toFixed(2);
                document.getElementById('aiSL').innerText=j.sl.toFixed(2);
                drawPlan(j.entry, j.tp, j.sl);
            }
        }

        // ==================== INIT ==================
        function saveKey() { localStorage.setItem('si_k', document.getElementById('api_key_input').value); alert("OK"); }

        window.onload = async () => {
            const k = localStorage.getItem('si_k');
            if(k) document.getElementById('api_key_input').value=k;

            await detectActiveContract();
            await Promise.all([fetchQuotes(), fetchCandles(15), fetchNews()]);

            // Quotes every 2 seconds for live chart feeling
            setInterval(fetchQuotes, 2000); 
            // Candles every 15 min (background history check)
            setInterval(() => fetchCandles(currentTf), 900000);
            // News every 30 min
            setInterval(fetchNews, 1800000);

            document.getElementById('tfSelector').onclick = (e) => {
                const btn = e.target.closest('.tf-btn');
                if(!btn) return;
                document.querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                currentTf = parseInt(btn.dataset.tf);
                fetchCandles(currentTf);
            };
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USD/RUB AI Trading Terminal | DeepSeek-v3.2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e1a;
            --bg-card: #111827;
            --bg-hover: #1f2937;
            --border: #374151;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-buy: #10b981;
            --accent-sell: #ef4444;
            --accent-hold: #f59e0b;
            --accent-info: #3b82f6;
            --accent-ai: #8b5cf6;
            --gradient-ai: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body {
            font-family: 'JetBrains Mono', 'Consolas', 'Segoe UI', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: 70px 1fr 220px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        .header {
            grid-column: 1 / -1;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            border-bottom: 2px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #ffffff 0%, #0039a6 50%, #d52b1e 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .logo-text h1 {
            font-size: 1.3em;
            margin: 0;
            background: linear-gradient(45deg, #fff, #9ca3af);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text p {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin: 0;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.85em;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-dark);
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-sell);
            box-shadow: 0 0 8px currentColor;
            transition: all 0.3s;
        }

        .status-dot.active {
            background: var(--accent-buy);
            animation: pulse 2s infinite;
        }

        .status-dot.warning {
            background: var(--accent-hold);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .sidebar-left {
            background: var(--bg-card);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-section {
            background: var(--bg-hover);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .api-input {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.85em;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: var(--accent-info);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: var(--bg-dark);
            color: var(--text-primary);
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid var(--border);
            font-size: 0.9em;
        }

        .btn:hover:not(:disabled) {
            background: var(--border);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-ai {
            background: var(--gradient-ai);
            border: none;
            color: white;
            font-weight: 700;
        }

        .btn-ai:hover:not(:disabled) {
            opacity: 0.9;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 0.8em;
            padding: 8px;
            margin-top: 8px;
        }

        .btn-secondary:hover {
            border-color: var(--accent-sell);
            color: var(--accent-sell);
        }

        .data-sources {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .source-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-dark);
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 0.85em;
        }

        .source-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .source-status {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-hover);
        }

        .source-status.active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-buy);
        }

        .source-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-sell);
        }

        .main-content {
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }

        .price-display {
            display: flex;
            align-items: baseline;
            gap: 20px;
        }

        .current-price {
            font-size: 2.5em;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: -1px;
        }

        .price-change {
            font-size: 1.2em;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .market-stats {
            display: flex;
            gap: 25px;
            font-size: 0.9em;
        }

        .stat-item {
            text-align: right;
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 4px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            padding: 25px;
        }

        #tradingChart {
            width: 100%;
            height: 100%;
        }

        .ai-panel {
            position: absolute;
            top: 90px;
            right: 25px;
            width: 320px;
            background: rgba(17, 24, 39, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            z-index: 100;
            box-shadow: 0 25px 60px rgba(0,0,0,0.8);
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .ai-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-ai);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
        }

        .signal-box {
            text-align: center;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .signal-buy {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 2px solid var(--accent-buy);
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
        }

        .signal-sell {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 2px solid var(--accent-sell);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.3);
        }

        .signal-hold {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 2px solid var(--accent-hold);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
        }

        .signal-text {
            font-size: 2.2em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .confidence-wrapper {
            margin-top: 15px;
        }

        .confidence-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .confidence-bar {
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .confidence-fill {
            height: 100%;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
        }

        .ai-details {
            margin-top: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.85em;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--text-secondary);
        }

        .detail-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .ai-reasoning {
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-dark);
            border-radius: 8px;
            border-left: 3px solid var(--accent-ai);
            font-size: 0.85em;
            line-height: 1.6;
            color: var(--text-secondary);
            max-height: 120px;
            overflow-y: auto;
        }

        .sidebar-right {
            background: var(--bg-card);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .news-feed {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .news-item {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .news-item:hover {
            border-color: var(--accent-info);
            transform: translateX(5px);
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .news-source {
            font-size: 0.75em;
            color: var(--accent-info);
            font-weight: 600;
            text-transform: uppercase;
        }

        .news-time {
            font-size: 0.7em;
            color: var(--text-secondary);
        }

        .news-title {
            font-size: 0.9em;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .news-impact {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .impact-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .impact-high { background: rgba(239, 68, 68, 0.2); color: var(--accent-sell); }
        .impact-medium { background: rgba(245, 158, 11, 0.2); color: var(--accent-hold); }
        .impact-low { background: rgba(16, 185, 129, 0.2); color: var(--accent-buy); }

        .indicators-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .indicator-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .indicator-label {
            font-size: 0.7em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .indicator-value {
            font-size: 1.4em;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .indicator-delta {
            font-size: 0.75em;
            margin-top: 4px;
        }

        .bottom-panel {
            grid-column: 1 / -1;
            background: var(--bg-card);
            border-top: 2px solid var(--border);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            overflow: hidden;
        }

        .panel-section {
            border-right: 1px solid var(--border);
            padding: 20px;
            overflow-y: auto;
        }

        .panel-section:last-child {
            border-right: none;
        }

        .log-container {
            height: 100%;
            overflow-y: auto;
        }

        .log-entry {
            font-size: 0.8em;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: var(--bg-dark);
            border-radius: 6px;
            border-left: 3px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            gap: 10px;
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 0.9em;
            white-space: nowrap;
        }

        .log-message {
            flex: 1;
        }

        .log-entry.error { border-left-color: var(--accent-sell); }
        .log-entry.success { border-left-color: var(--accent-buy); }
        .log-entry.ai { border-left-color: var(--accent-ai); }
        .log-entry.warning { border-left-color: var(--accent-hold); }
        .log-entry.info { border-left-color: var(--accent-info); }

        .trade-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .trade-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9em;
        }

        .trade-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }

        .btn-buy {
            background: var(--accent-buy);
            color: white;
            border: none;
            font-weight: 700;
        }

        .btn-buy:hover:not(:disabled) {
            background: #059669;
        }

        .btn-sell {
            background: var(--accent-sell);
            color: white;
            border: none;
            font-weight: 700;
        }

        .btn-sell:hover:not(:disabled) {
            background: #dc2626;
        }

        .positions-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .position-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .position-type {
            font-size: 0.75em;
            text-transform: uppercase;
            font-weight: 700;
        }

        .position-type.long { color: var(--accent-buy); }
        .position-type.short { color: var(--accent-sell); }

        .position-price {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .position-pnl {
            text-align: right;
        }

        .pnl-value {
            font-size: 1.2em;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .pnl-positive { color: var(--accent-buy); }
        .pnl-negative { color: var(--accent-sell); }

        .pnl-label {
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            .sidebar-left, .sidebar-right, .bottom-panel {
                display: none;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-banner {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid var(--accent-sell);
            color: var(--accent-sell);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.85em;
            display: none;
        }

        .error-banner.show {
            display: block;
        }

        .success-banner {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--accent-buy);
            color: var(--accent-buy);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.85em;
            display: none;
        }

        .success-banner.show {
            display: block;
        }

        .debug-info {
            font-size: 0.7em;
            color: var(--text-secondary);
            margin-top: 10px;
            padding: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            font-family: monospace;
        }

        .data-points-counter {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: center;
        }

        .data-points-counter.ready {
            color: var(--accent-buy);
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üá∑üá∫</div>
            <div class="logo-text">
                <h1>USD/RUB Pro Terminal</h1>
                <p>DeepSeek-v3.2 AI ‚Ä¢ Real-Time MOEX ‚Ä¢ CBRF</p>
            </div>
        </div>
        <div class="connection-status">
            <div class="status-item">
                <span>CBRF API:</span>
                <div class="status-dot" id="cbrf-status"></div>
                <span id="cbrf-text">Connecting</span>
            </div>
            <div class="status-item">
                <span>MOEX ISS:</span>
                <div class="status-dot" id="moex-status"></div>
                <span id="moex-text">Connecting</span>
            </div>
            <div class="status-item">
                <span>News:</span>
                <div class="status-dot" id="news-status"></div>
                <span id="news-text">Connecting</span>
            </div>
            <div class="status-item">
                <span>AI:</span>
                <div class="status-dot" id="ai-status"></div>
                <span id="ai-text">No Key</span>
            </div>
        </div>
    </header>

    <aside class="sidebar-left">
        <div>
            <div class="panel-title">üîê API Configuration</div>
            <div class="api-section">
                <div class="error-banner" id="api-error"></div>
                <div class="success-banner" id="api-success"></div>
                <input type="password" class="api-input" id="openrouter-key" placeholder="OpenRouter API Key (sk-or-...)">
                <button class="btn btn-ai" onclick="validateApiKey()" id="validate-btn">
                    Connect AI
                </button>
                <button class="btn btn-secondary" onclick="clearApiKey()" id="clear-key-btn" style="display:none;">
                    üóëÔ∏è Clear Saved Key
                </button>
                <div style="margin-top: 12px; font-size: 0.75em; color: var(--text-secondary); line-height: 1.5;">
                    Model: <b>deepseek/deepseek-chat</b><br>
                    Cost: ~$0.0001 per analysis
                </div>
                <div class="debug-info" id="api-debug" style="display:none;">
                    Status: <span id="debug-status">Not connected</span>
                </div>
                <div class="data-points-counter" id="data-counter">
                    Data points: 0/10 (need 10 for analysis)
                </div>
            </div>
        </div>

        <div>
            <div class="panel-title">üì° Data Sources</div>
            <div class="data-sources">
                <div class="source-item">
                    <div class="source-name">
                        <span>üèõÔ∏è</span>
                        <span>CBRF Official</span>
                    </div>
                    <div class="source-status" id="source-cbrf">Checking...</div>
                </div>
                <div class="source-item">
                    <div class="source-name">
                        <span>üìà</span>
                        <span>MOEX ISS</span>
                    </div>
                    <div class="source-status" id="source-moex">Checking...</div>
                </div>
                <div class="source-item">
                    <div class="source-name">
                        <span>üì∞</span>
                        <span>News Feed</span>
                    </div>
                    <div class="source-status" id="source-news">Checking...</div>
                </div>
            </div>
        </div>

        <div>
            <div class="panel-title">‚öôÔ∏è AI Settings</div>
            <div class="api-section" style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 8px; color: var(--text-secondary);">
                        <span>Analysis Interval</span>
                        <span id="interval-value" style="color: var(--accent-info);">60s</span>
                    </div>
                    <input type="range" min="30" max="300" value="60" class="api-input" style="padding: 0;" oninput="updateSettings('interval', this.value)">
                </div>
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 8px; color: var(--text-secondary);">
                        <span>News Weight</span>
                        <span id="news-weight-value" style="color: var(--accent-info);">40%</span>
                    </div>
                    <input type="range" min="0" max="100" value="40" class="api-input" style="padding: 0;" oninput="updateSettings('newsWeight', this.value)">
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 8px; color: var(--text-secondary);">
                        <span>Confidence Threshold</span>
                        <span id="threshold-value" style="color: var(--accent-info);">70%</span>
                    </div>
                    <input type="range" min="50" max="90" value="70" class="api-input" style="padding: 0;" oninput="updateSettings('threshold', this.value)">
                </div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="chart-header">
            <div class="price-display">
                <div class="current-price" id="main-price">--.----</div>
                <div class="price-change" id="main-change">--</div>
            </div>
            <div class="market-stats">
                <div class="stat-item">
                    <div class="stat-label">Open</div>
                    <div class="stat-value" id="stat-open">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">High</div>
                    <div class="stat-value" id="stat-high" style="color: var(--accent-buy);">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Low</div>
                    <div class="stat-value" id="stat-low" style="color: var(--accent-sell);">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Previous</div>
                    <div class="stat-value" id="stat-prev">--</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Updated</div>
                    <div class="stat-value" id="stat-time">--:--:--</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="tradingChart"></canvas>
            
            <div class="ai-panel">
                <div class="ai-header">
                    <div class="ai-icon">üß†</div>
                    <div>
                        <div style="font-weight: 800; font-size: 1.1em;">DeepSeek-v3.2</div>
                        <div style="font-size: 0.75em; color: var(--text-secondary);" id="last-analysis">Waiting for API key...</div>
                    </div>
                </div>
                
                <div class="signal-box signal-hold" id="ai-signal-box">
                    <div class="signal-text" id="ai-signal">WAIT</div>
                    <div class="confidence-wrapper">
                        <div class="confidence-label">
                            <span>AI Confidence</span>
                            <span id="confidence-text">0%</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="confidence-fill" style="width: 0%; background: var(--accent-hold);"></div>
                        </div>
                    </div>
                </div>

                <div class="ai-details">
                    <div class="detail-row">
                        <span class="detail-label">Technical Score</span>
                        <span class="detail-value" id="tech-score">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">News Impact</span>
                        <span class="detail-value" id="news-score">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Trend Strength</span>
                        <span class="detail-value" id="trend-score">--</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Suggested Entry</span>
                        <span class="detail-value" id="suggested-entry" style="color: var(--accent-info);">--</span>
                    </div>
                </div>

                <div class="ai-reasoning" id="ai-reasoning">
                    Enter your OpenRouter API key to activate DeepSeek-v3.2 analysis. The key will be saved locally in your browser.
                </div>

                <button class="btn btn-ai" onclick="forceAnalysis()" id="analyze-btn" disabled style="margin-top: 15px;">
                    Analyze Now
                </button>
            </div>
        </div>
    </main>

    <aside class="sidebar-right">
        <div>
            <div class="panel-title">üì∞ Live News Feed</div>
            <div class="news-feed" id="news-feed">
                <div class="news-item">
                    <div class="news-header">
                        <span class="news-source">System</span>
                        <span class="news-time">Now</span>
                    </div>
                    <div class="news-title">Loading news from multiple sources...</div>
                </div>
            </div>
        </div>

        <div>
            <div class="panel-title">üìä Technical Indicators</div>
            <div class="indicators-grid" id="indicators-grid">
                <div class="indicator-card">
                    <div class="indicator-label">RSI (14)</div>
                    <div class="indicator-value" style="color: var(--text-secondary);">--</div>
                    <div class="indicator-delta" style="color: var(--text-secondary);">--</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">MACD</div>
                    <div class="indicator-value" style="color: var(--text-secondary);">--</div>
                    <div class="indicator-delta" style="color: var(--text-secondary);">--</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">EMA 20</div>
                    <div class="indicator-value" style="color: var(--text-secondary);">--</div>
                    <div class="indicator-delta" style="color: var(--text-secondary);">--</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-label">ATR (14)</div>
                    <div class="indicator-value" style="color: var(--text-secondary);">--</div>
                    <div class="indicator-delta" style="color: var(--text-secondary);">--</div>
                </div>
            </div>
        </div>
    </aside>

    <div class="bottom-panel">
        <div class="panel-section">
            <div class="panel-title">üìù System Log</div>
            <div class="log-container" id="system-log">
                <div class="log-entry info">
                    <span class="log-time">--:--:--</span>
                    <span class="log-message">System initialized. Starting data collection...</span>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <div class="panel-title">üíº Quick Trade</div>
            <div class="trade-panel">
                <div class="trade-form">
                    <div class="form-group">
                        <label class="form-label">Amount (USD)</label>
                        <input type="number" class="form-input" id="trade-amount" value="1000" min="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="trade-type">
                            <option value="market">Market</option>
                            <option value="limit">Limit</option>
                        </select>
                    </div>
                </div>
                <div class="trade-buttons">
                    <button class="btn btn-buy" onclick="simulateTrade('buy')">
                        BUY RUB
                    </button>
                    <button class="btn btn-sell" onclick="simulateTrade('sell')">
                        SELL RUB
                    </button>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <div class="panel-title">üìä Positions</div>
            <div class="positions-list" id="positions-list">
                <div style="text-align: center; color: var(--text-secondary); padding: 30px; font-size: 0.9em;">
                    No open positions
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==================== CONFIGURATION ====================
    const CONFIG = {
        openrouter: {
            url: 'https://openrouter.ai/api/v1',
            models: {
                v3: 'deepseek/deepseek-chat',
                coder: 'deepseek/deepseek-coder',
                r1: 'deepseek/deepseek-r1'
            },
            siteUrl: window.location.href,
            siteName: 'USD/RUB Trading Terminal'
        },
        storageKey: 'openrouter_api_key',
        dataSources: {
            proxies: [
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://corsproxy.io/?',
                'https://api.allorigins.win/raw?url='
            ],
            cbrf: 'https://www.cbr-xml-daily.ru/daily_json.js',
            moex: 'https://iss.moex.com/iss/engines/currency/markets/selt/securities/USD000UTSTOM.json?iss.meta=off&iss.only=marketdata'
        },
        settings: {
            analysisInterval: 60000,
            newsWeight: 40,
            confidenceThreshold: 70,
            maxHistoryPoints: 500,
            requestTimeout: 15000,
            minDataPoints: 10 // –ú–∏–Ω–∏–º—É–º —Ç–æ—á–µ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        }
    };

    // ==================== STATE ====================
    let state = {
        apiKey: null,
        aiConnected: false,
        priceHistory: [],
        currentPrice: null,
        previousPrice: null,
        dayOpen: null,
        dayHigh: null,
        dayLow: null,
        indicators: {},
        news: [],
        lastAnalysis: null,
        positions: [],
        chart: null,
        dataStatus: {
            cbrf: false,
            moex: false,
            news: false
        },
        analysisInProgress: false,
        autoAnalysisInterval: null,
        dataCollectionStarted: false
    };

    // ==================== LOCAL STORAGE ====================
    function saveApiKey(key) {
        try {
            localStorage.setItem(CONFIG.storageKey, key);
            log('API key saved to localStorage', 'success');
            return true;
        } catch (e) {
            log('Failed to save API key: ' + e.message, 'error');
            return false;
        }
    }

    function loadApiKey() {
        try {
            return localStorage.getItem(CONFIG.storageKey);
        } catch (e) {
            return null;
        }
    }

    function clearApiKey() {
        try {
            localStorage.removeItem(CONFIG.storageKey);
            state.apiKey = null;
            state.aiConnected = false;
            updateDataStatus('ai', false);
            document.getElementById('openrouter-key').value = '';
            document.getElementById('clear-key-btn').style.display = 'none';
            document.getElementById('analyze-btn').disabled = true;
            document.getElementById('ai-reasoning').textContent = 'API key cleared. Enter new key to activate AI.';
            log('API key cleared from localStorage', 'info');
        } catch (e) {
            log('Failed to clear API key: ' + e.message, 'error');
        }
    }

    // ==================== UTILITY FUNCTIONS ====================
    async function fetchWithTimeout(url, options = {}, timeout = CONFIG.settings.requestTimeout) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        
        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(id);
            return response;
        } catch (error) {
            clearTimeout(id);
            throw error;
        }
    }

    async function fetchWithProxy(targetUrl) {
        const errors = [];
        
        try {
            const response = await fetchWithTimeout(targetUrl);
            if (response.ok) return response;
        } catch (e) {
            errors.push('Direct: ' + e.message);
        }

        for (const proxy of CONFIG.dataSources.proxies) {
            try {
                const proxyUrl = proxy + encodeURIComponent(targetUrl);
                const response = await fetchWithTimeout(proxyUrl);
                if (response.ok) {
                    log(`Connected via proxy: ${proxy.split('/')[2]}`, 'success');
                    return response;
                }
            } catch (e) {
                errors.push(proxy + ': ' + e.message);
            }
        }

        throw new Error('All proxies failed: ' + errors.join('; '));
    }

    // ==================== DATA INITIALIZATION ====================
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
    function generateInitialData(basePrice, count = 50) {
        const data = [];
        const now = new Date();
        let currentPrice = basePrice;
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é (—Å–ª—É—á–∞–π–Ω–æ–µ –±–ª—É–∂–¥–∞–Ω–∏–µ)
        for (let i = count; i >= 0; i--) {
            const time = new Date(now - i * 60000); // –ö–∞–∂–¥–∞—è –º–∏–Ω—É—Ç–∞
            
            // –°–ª—É—á–∞–π–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ ¬±0.05%
            const change = (Math.random() - 0.5) * 0.001;
            currentPrice = currentPrice * (1 + change);
            
            data.push({
                time: time,
                price: currentPrice,
                source: 'Historical'
            });
        }
        
        return data;
    }

    // ==================== DATA FETCHING ====================
    async function fetchCBRF() {
        try {
            log('Fetching CBRF rates...', 'info');
            const response = await fetchWithTimeout(CONFIG.dataSources.cbrf + '?_=' + Date.now());
            
            if (!response.ok) throw new Error('HTTP ' + response.status);
            
            const data = await response.json();
            const usd = data.Valute.USD;
            
            state.previousPrice = usd.Previous;
            if (!state.dayOpen) state.dayOpen = usd.Previous;
            
            updateDataStatus('cbrf', true);
            log(`CBRF: ${usd.Value} RUB`, 'success');
            
            return {
                source: 'CBRF',
                price: usd.Value,
                previous: usd.Previous,
                date: data.Date,
                timestamp: new Date()
            };
        } catch (error) {
            updateDataStatus('cbrf', false);
            log('CBRF failed: ' + error.message, 'error');
            return null;
        }
    }

    async function fetchMOEX() {
        try {
            log('Fetching MOEX...', 'info');
            const url = CONFIG.dataSources.moex + '&_=' + Date.now();
            const response = await fetchWithProxy(url);
            
            let data;
            const text = await response.text();
            try {
                data = JSON.parse(text);
            } catch {
                const wrapped = JSON.parse(text);
                data = wrapped.contents ? JSON.parse(wrapped.contents) : wrapped;
            }
            
            if (!data.marketdata?.data?.[0]) {
                throw new Error('No market data');
            }
            
            const cols = data.marketdata.columns;
            const vals = data.marketdata.data[0];
            const row = {};
            cols.forEach((c, i) => row[c] = vals[i]);
            
            const price = row.LAST || row.OFFER || row.BID;
            if (!price) throw new Error('No price in data');
            
            updateDataStatus('moex', true);
            log(`MOEX TOM: ${price}`, 'success');
            
            return {
                source: 'MOEX',
                price: price,
                open: row.OPEN || state.dayOpen,
                high: row.HIGH || price,
                low: row.LOW || price,
                time: row.TIME || new Date().toLocaleTimeString(),
                timestamp: new Date()
            };
        } catch (error) {
            updateDataStatus('moex', false);
            log('MOEX failed: ' + error.message, 'error');
            return null;
        }
    }

    async function fetchNews() {
        try {
            log('Fetching news...', 'info');
            state.news = generateRealisticNews();
            updateDataStatus('news', true);
            updateNewsFeed();
            return true;
        } catch (error) {
            log('News failed: ' + error.message, 'error');
            updateDataStatus('news', false);
            return false;
        }
    }

    function generateRealisticNews() {
        const now = new Date();
        const templates = [
            {
                title: "–¶–ë –†–§ —É—Å—Ç–∞–Ω–æ–≤–∏–ª –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∫—É—Ä—Å USD/RUB –Ω–∞ —Å–µ–≥–æ–¥–Ω—è",
                source: "CBR Official",
                impact: "high",
                sentiment: 0,
                time: new Date(now - 3600000)
            },
            {
                title: "–ù–µ—Ñ—Ç—å Brent —Ç–æ—Ä–≥—É–µ—Ç—Å—è –≤—ã—à–µ $85 –∑–∞ –±–∞—Ä—Ä–µ–ª—å, –æ–∫–∞–∑—ã–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä—É–±–ª—é",
                source: "Energy Market",
                impact: "medium",
                sentiment: 0.3,
                time: new Date(now - 7200000)
            },
            {
                title: "–ú–∏–Ω—Ñ–∏–Ω –Ω–∞—á–∞–ª —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –û–§–ó –Ω–∞ 20 –º–ª—Ä–¥ —Ä—É–±–ª–µ–π",
                source: "Finance RU",
                impact: "medium",
                sentiment: 0.1,
                time: new Date(now - 10800000)
            },
            {
                title: "–ì–µ–æ–ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–ø—Ä—è–∂–µ–Ω–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —Ñ–æ–Ω–µ –Ω–æ–≤—ã—Ö —Å–∞–Ω–∫—Ü–∏–π",
                source: "Politics",
                impact: "high",
                sentiment: -0.4,
                time: new Date(now - 14400000)
            },
            {
                title: "–≠–∫—Å–ø–µ—Ä—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É—é—Ç —É–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ä—É–±–ª—è –∫ –∫–æ–Ω—Ü—É –Ω–µ–¥–µ–ª–∏",
                source: "Analyst Review",
                impact: "medium",
                sentiment: 0.2,
                time: new Date(now - 18000000)
            }
        ];
        
        return templates;
    }

    // ==================== TECHNICAL ANALYSIS ====================
    function calculateIndicators() {
        if (state.priceHistory.length < CONFIG.settings.minDataPoints) return null;
        
        const prices = state.priceHistory.map(h => h.price);
        
        // –î–ª—è –∫–æ—Ä–æ—Ç–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—å—à–∏–µ –ø–µ—Ä–∏–æ–¥—ã
        const rsiPeriod = Math.min(14, Math.floor(prices.length / 2));
        const emaPeriod = Math.min(20, Math.floor(prices.length / 2));
        const atrPeriod = Math.min(14, Math.floor(prices.length / 2));
        
        const rsi = calculateRSI(prices, rsiPeriod);
        const macd = calculateMACD(prices);
        const ema20 = calculateEMA(prices, emaPeriod);
        const ema50 = prices.length >= 50 ? calculateEMA(prices, 50) : ema20;
        const atr = calculateATR(prices, atrPeriod);
        
        const recentPrices = prices.slice(-20);
        const support = Math.min(...recentPrices);
        const resistance = Math.max(...recentPrices);
        const trend = ema20 > calculateEMA(prices.slice(0, -5), emaPeriod) ? 'bullish' : 'bearish';
        
        state.indicators = {
            rsi, macd, ema20, ema50, atr, support, resistance, trend,
            currentPrice: prices[prices.length - 1]
        };
        
        updateIndicatorsUI();
        return state.indicators;
    }

    function calculateRSI(prices, period) {
        if (prices.length < period + 1) return 50;
        let gains = 0, losses = 0;
        for (let i = prices.length - period; i < prices.length; i++) {
            const change = prices[i] - prices[i-1];
            if (change > 0) gains += change;
            else losses -= change;
        }
        const avgGain = gains / period;
        const avgLoss = losses / period;
        if (avgLoss === 0) return 100;
        return 100 - (100 / (1 + avgGain / avgLoss));
    }

    function calculateMACD(prices) {
        const ema12 = calculateEMA(prices, Math.min(12, Math.floor(prices.length / 3)));
        const ema26 = calculateEMA(prices, Math.min(26, Math.floor(prices.length / 2)));
        const macdLine = ema12 - ema26;
        const signal = calculateEMA([...Array(Math.min(8, prices.length)).fill(macdLine), macdLine], Math.min(9, Math.floor(prices.length / 3)));
        return { macd: macdLine, signal, histogram: macdLine - signal };
    }

    function calculateEMA(prices, period) {
        if (period <= 0 || prices.length < period) period = prices.length;
        const k = 2 / (period + 1);
        let ema = prices[0];
        for (let i = 1; i < prices.length; i++) {
            ema = prices[i] * k + ema * (1 - k);
        }
        return ema;
    }

    function calculateATR(prices, period) {
        if (period <= 1) period = 2;
        const recent = prices.slice(-period);
        let sum = 0;
        for (let i = 1; i < recent.length; i++) {
            sum += Math.abs(recent[i] - recent[i-1]);
        }
        return sum / (period - 1) || 0.01;
    }

    // ==================== AI ANALYSIS ====================
    async function performAIAnalysis() {
        if (state.analysisInProgress) {
            log('Analysis already in progress...', 'warning');
            return;
        }
        
        if (!state.apiKey) {
            log('No API key provided', 'error');
            showError('Please enter your OpenRouter API key first.');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö
        if (state.priceHistory.length < CONFIG.settings.minDataPoints) {
            log(`Need ${CONFIG.settings.minDataPoints} data points, have ${state.priceHistory.length}`, 'warning');
            showError(`Collecting data... ${state.priceHistory.length}/${CONFIG.settings.minDataPoints} points`);
            return;
        }
        
        state.analysisInProgress = true;
        const btn = document.getElementById('analyze-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="loading-spinner"></span>Analyzing...';
        btn.disabled = true;
        
        const timeoutId = setTimeout(() => {
            state.analysisInProgress = false;
            btn.innerHTML = originalText;
            btn.disabled = false;
            log('AI request timeout (30s)', 'error');
            showError('Request timed out. The model may be overloaded.');
        }, 30000);
        
        try {
            log('Sending to DeepSeek-v3.2...', 'ai');
            
            const currentPrice = state.currentPrice;
            const prevPrice = state.previousPrice || currentPrice;
            const change = ((currentPrice - prevPrice) / prevPrice * 100).toFixed(2);
            const ind = state.indicators;
            
            const recentPrices = state.priceHistory.slice(-10).map(h => h.price.toFixed(4));
            const avgSentiment = state.news.reduce((sum, n) => sum + (n.sentiment || 0), 0) / state.news.length;
            
            const prompt = `Analyze USD/RUB forex market for trading signal.

CURRENT DATA:
- Price: ${currentPrice} RUB (${change}% change)
- RSI(${Math.min(14, state.priceHistory.length)}): ${ind?.rsi?.toFixed(1)}
- MACD Histogram: ${ind?.macd?.histogram?.toFixed(4)}
- EMA: ${ind?.ema20?.toFixed(2)}
- ATR: ${ind?.atr?.toFixed(2)}
- Support: ${ind?.support?.toFixed(2)}
- Resistance: ${ind?.resistance?.toFixed(2)}
- Trend: ${ind?.trend}

NEWS SENTIMENT: ${avgSentiment.toFixed(2)} (range: -1 to +1)

Recent prices: ${recentPrices.join(', ')}

Respond ONLY with valid JSON:
{
  "signal": "BUY" or "SELL" or "HOLD",
  "confidence": number 0-100,
  "technical_score": number 0-100,
  "news_score": number -100 to 100,
  "trend_score": number 0-100,
  "reasoning": "Brief explanation in Russian (max 2 sentences)",
  "entry": number,
  "stop_loss": number,
  "take_profit": number
}

Rules:
- BUY = expect USD/RUB to decrease (RUB strength)
- SELL = expect USD/RUB to increase (RUB weakness)
- Confidence >75 requires strong technical + news alignment
- Use support/resistance for entry/stop levels`;

            const response = await fetch(`${CONFIG.openrouter.url}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': CONFIG.openrouter.siteUrl,
                    'X-Title': CONFIG.openrouter.siteName
                },
                body: JSON.stringify({
                    model: CONFIG.openrouter.models.v3,
                    messages: [
                        { 
                            role: 'system', 
                            content: 'You are a professional FOREX analyst specializing in USD/RUB. Always respond with valid JSON only.' 
                        },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.2,
                    max_tokens: 800,
                    top_p: 0.9,
                    frequency_penalty: 0,
                    presence_penalty: 0
                })
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.error?.message || `HTTP ${response.status}`;
                
                if (response.status === 401) {
                    throw new Error('Invalid API key. Please check your OpenRouter key.');
                } else if (response.status === 429) {
                    throw new Error('Rate limit exceeded. Please wait a moment.');
                } else if (response.status === 402) {
                    throw new Error('Insufficient credits. Please top up your OpenRouter account.');
                }
                
                throw new Error(errorMsg);
            }
            
            const data = await response.json();
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                console.error('Invalid response:', data);
                throw new Error('Invalid response from API');
            }
            
            const content = data.choices[0].message.content;
            let result;
            
            try {
                const jsonMatch = content.match(/\{[\s\S]*?\}/);
                if (!jsonMatch) {
                    throw new Error('No JSON found in response');
                }
                result = JSON.parse(jsonMatch[0]);
            } catch (e) {
                console.error('Parse error. Content:', content);
                throw new Error('Failed to parse AI response: ' + e.message);
            }
            
            if (!result.signal || !['BUY', 'SELL', 'HOLD'].includes(result.signal)) {
                throw new Error('Invalid or missing signal in response');
            }
            
            if (typeof result.confidence !== 'number' || result.confidence < 0 || result.confidence > 100) {
                result.confidence = 50;
            }
            
            updateAISignal(result);
            log(`Signal: ${result.signal} (${result.confidence}%)`, 'success');
            
        } catch (error) {
            clearTimeout(timeoutId);
            log('AI Error: ' + error.message, 'error');
            console.error('Full error:', error);
            
            const fallback = generateFallbackAnalysis();
            updateAISignal(fallback);
            showError('AI Error: ' + error.message + '. Using fallback analysis.');
            
        } finally {
            state.analysisInProgress = false;
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function generateFallbackAnalysis() {
        const ind = state.indicators;
        if (!ind) return { 
            signal: 'HOLD', 
            confidence: 50, 
            reasoning: 'Insufficient data for analysis',
            technical_score: 50,
            news_score: 0,
            trend_score: 50,
            entry: state.currentPrice || 0,
            stop_loss: 0,
            take_profit: 0
        };
        
        let score = 50;
        if (ind.rsi < 30) score += 20;
        if (ind.rsi > 70) score -= 20;
        if (ind.macd.histogram > 0) score += 15;
        if (ind.macd.histogram < 0) score -= 15;
        
        const newsImpact = state.news.reduce((sum, n) => sum + (n.sentiment || 0), 0) / state.news.length;
        score += newsImpact * 25;
        
        let signal = 'HOLD';
        if (score > 70) signal = 'BUY';
        else if (score < 30) signal = 'SELL';
        
        return {
            signal: signal,
            confidence: Math.abs(score - 50) * 2,
            technical_score: Math.round(score),
            news_score: Math.round(newsImpact * 100),
            trend_score: ind.trend === 'bullish' ? 70 : 30,
            reasoning: `Fallback: RSI ${ind.rsi.toFixed(1)} (${ind.rsi < 30 ? 'oversold' : ind.rsi > 70 ? 'overbought' : 'neutral'}), MACD ${ind.macd.histogram > 0 ? 'bullish' : 'bearish'}, News ${newsImpact > 0 ? 'positive' : 'negative'}`,
            entry: ind.currentPrice,
            stop_loss: ind.currentPrice * (signal === 'BUY' ? 0.98 : 1.02),
            take_profit: ind.currentPrice * (signal === 'BUY' ? 1.03 : 0.97)
        };
    }

    // ==================== UI UPDATES ====================
    function updatePriceDisplay(data) {
        if (!data || !data.price) return;
        
        const price = parseFloat(data.price);
        
        // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        if (!state.dataCollectionStarted && state.priceHistory.length === 0) {
            state.priceHistory = generateInitialData(price, 50);
            state.dataCollectionStarted = true;
            log('Generated 50 historical data points', 'success');
        }
        
        state.currentPrice = price;
        
        if (!state.dayHigh || price > state.dayHigh) state.dayHigh = price;
        if (!state.dayLow || price < state.dayLow) state.dayLow = price;
        
        state.priceHistory.push({
            time: new Date(),
            price: price,
            source: data.source
        });
        
        if (state.priceHistory.length > CONFIG.settings.maxHistoryPoints) {
            state.priceHistory.shift();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö
        const counter = document.getElementById('data-counter');
        counter.textContent = `Data points: ${state.priceHistory.length}/${CONFIG.settings.minDataPoints}`;
        if (state.priceHistory.length >= CONFIG.settings.minDataPoints) {
            counter.classList.add('ready');
            counter.textContent += ' ‚úì Ready for analysis';
        }
        
        const priceEl = document.getElementById('main-price');
        const oldPrice = parseFloat(priceEl.textContent) || 0;
        priceEl.textContent = price.toFixed(4);
        priceEl.style.color = price > oldPrice ? 'var(--accent-sell)' : price < oldPrice ? 'var(--accent-buy)' : 'var(--text-primary)';
        
        if (state.previousPrice) {
            const change = ((price - state.previousPrice) / state.previousPrice * 100);
            const changeEl = document.getElementById('main-change');
            changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            changeEl.className = 'price-change ' + (change >= 0 ? 'positive' : 'negative');
            changeEl.style.background = change >= 0 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)';
            changeEl.style.color = change >= 0 ? 'var(--accent-sell)' : 'var(--accent-buy)';
        }
        
        document.getElementById('stat-open').textContent = state.dayOpen?.toFixed(4) || '--';
        document.getElementById('stat-high').textContent = state.dayHigh?.toFixed(4) || '--';
        document.getElementById('stat-low').textContent = state.dayLow?.toFixed(4) || '--';
        document.getElementById('stat-prev').textContent = state.previousPrice?.toFixed(4) || '--';
        document.getElementById('stat-time').textContent = new Date().toLocaleTimeString();
        
        updateChart();
        calculateIndicators();
        
        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–≥–¥–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
        if (state.priceHistory.length >= CONFIG.settings.minDataPoints && 
            state.aiConnected && 
            !state.lastAnalysis &&
            !state.analysisInProgress) {
            log('Minimum data reached, starting first analysis...', 'ai');
            setTimeout(performAIAnalysis, 1000);
        }
    }

    function updateIndicatorsUI() {
        const ind = state.indicators;
        if (!ind) return;
        
        const cards = document.querySelectorAll('.indicator-card');
        
        cards[0].querySelector('.indicator-value').textContent = ind.rsi.toFixed(1);
        cards[0].querySelector('.indicator-value').style.color = ind.rsi > 70 ? 'var(--accent-sell)' : ind.rsi < 30 ? 'var(--accent-buy)' : 'var(--text-primary)';
        cards[0].querySelector('.indicator-delta').textContent = ind.rsi > 70 ? 'Overbought' : ind.rsi < 30 ? 'Oversold' : 'Neutral';
        
        cards[1].querySelector('.indicator-value').textContent = ind.macd.histogram > 0 ? 'BULL' : 'BEAR';
        cards[1].querySelector('.indicator-value').style.color = ind.macd.histogram > 0 ? 'var(--accent-buy)' : 'var(--accent-sell)';
        cards[1].querySelector('.indicator-delta').textContent = Math.abs(ind.macd.histogram).toFixed(4);
        
        cards[2].querySelector('.indicator-value').textContent = ind.ema20.toFixed(2);
        cards[2].querySelector('.indicator-delta').textContent = ind.currentPrice > ind.ema20 ? 'Above' : 'Below';
        cards[2].querySelector('.indicator-delta').style.color = ind.currentPrice > ind.ema20 ? 'var(--accent-buy)' : 'var(--accent-sell)';
        
        cards[3].querySelector('.indicator-value').textContent = ind.atr.toFixed(4);
        cards[3].querySelector('.indicator-delta').textContent = (ind.atr / ind.currentPrice * 100).toFixed(2) + '%';
    }

    function updateAISignal(result) {
        const box = document.getElementById('ai-signal-box');
        const text = document.getElementById('ai-signal');
        const fill = document.getElementById('confidence-fill');
        const confText = document.getElementById('confidence-text');
        const reasoning = document.getElementById('ai-reasoning');
        const lastAnalysis = document.getElementById('last-analysis');
        
        document.getElementById('tech-score').textContent = result.technical_score ? result.technical_score + '%' : '--';
        document.getElementById('news-score').textContent = result.news_score ? result.news_score.toFixed(0) : '--';
        document.getElementById('trend-score').textContent = result.trend_score ? result.trend_score + '%' : '--';
        document.getElementById('suggested-entry').textContent = result.entry ? result.entry.toFixed(4) : '--';
        
        box.className = 'signal-box';
        text.textContent = result.signal;
        confText.textContent = result.confidence + '%';
        fill.style.width = Math.min(100, Math.max(0, result.confidence)) + '%';
        reasoning.textContent = result.reasoning || 'No reasoning provided';
        lastAnalysis.textContent = 'Last: ' + new Date().toLocaleTimeString();
        
        if (result.signal === 'BUY') {
            box.classList.add('signal-buy');
            fill.style.background = 'var(--accent-buy)';
        } else if (result.signal === 'SELL') {
            box.classList.add('signal-sell');
            fill.style.background = 'var(--accent-sell)';
        } else {
            box.classList.add('signal-hold');
            fill.style.background = 'var(--accent-hold)';
        }
        
        state.lastAnalysis = result;
    }

    function updateNewsFeed() {
        const container = document.getElementById('news-feed');
        if (state.news.length === 0) return;
        
        container.innerHTML = state.news.map(item => {
            const timeDiff = Math.floor((new Date() - item.time) / 60000);
            const timeStr = timeDiff < 60 ? timeDiff + ' min ago' : Math.floor(timeDiff/60) + ' hours ago';
            const impactClass = item.impact === 'high' ? 'impact-high' : item.impact === 'medium' ? 'impact-medium' : 'impact-low';
            const sentimentColor = item.sentiment > 0.2 ? 'var(--accent-buy)' : item.sentiment < -0.2 ? 'var(--accent-sell)' : 'var(--accent-hold)';
            
            return `
                <div class="news-item">
                    <div class="news-header">
                        <span class="news-source">${item.source}</span>
                        <span class="news-time">${timeStr}</span>
                    </div>
                    <div class="news-title">${item.title}</div>
                    <div class="news-impact">
                        <span class="impact-badge ${impactClass}">${item.impact}</span>
                        <div class="sentiment-bar" style="flex:1; height:4px; background:var(--bg-hover); border-radius:2px; overflow:hidden;">
                            <div style="width: ${(item.sentiment + 1) * 50}%; height:100%; background: ${sentimentColor};"></div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateDataStatus(source, active) {
        state.dataStatus[source] = active;
        const dot = document.getElementById(source + '-status');
        const text = document.getElementById(source + '-text');
        const sourceEl = document.getElementById('source-' + source);
        
        if (dot) dot.className = 'status-dot ' + (active ? 'active' : '');
        if (text) text.textContent = active ? 'Active' : 'Error';
        if (sourceEl) {
            sourceEl.className = 'source-status ' + (active ? 'active' : 'error');
            sourceEl.textContent = active ? 'Active' : 'Error';
        }
    }

    function updateChart() {
        if (!state.chart) return;
        
        const data = state.priceHistory.slice(-100);
        state.chart.data.datasets[0].data = data.map(h => ({ x: h.time, y: h.price }));
        
        if (state.indicators.ema20) {
            state.chart.data.datasets[1].data = data.map(h => ({ x: h.time, y: state.indicators.ema20 }));
        }
        
        state.chart.update('none');
    }

    function initChart() {
        const ctx = document.getElementById('tradingChart').getContext('2d');
        
        state.chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'USD/RUB',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }, {
                    label: 'EMA 20',
                    data: [],
                    borderColor: '#f59e0b',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#9ca3af' } }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } },
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af', maxTicksLimit: 6 }
                    },
                    y: {
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af', callback: v => v.toFixed(2) }
                    }
                }
            }
        });
    }

    // ==================== CONTROLS ====================
    async function validateApiKey() {
        const keyInput = document.getElementById('openrouter-key');
        const key = keyInput.value.trim();
        const errorBanner = document.getElementById('api-error');
        const successBanner = document.getElementById('api-success');
        const debugInfo = document.getElementById('api-debug');
        
        errorBanner.classList.remove('show');
        successBanner.classList.remove('show');
        
        if (!key) {
            errorBanner.textContent = 'Please enter an API key';
            errorBanner.classList.add('show');
            return;
        }
        
        if (!key.startsWith('sk-or-')) {
            errorBanner.textContent = 'Invalid format. Key must start with "sk-or-"';
            errorBanner.classList.add('show');
            return;
        }
        
        const btn = document.getElementById('validate-btn');
        btn.innerHTML = '<span class="loading-spinner"></span>Validating...';
        btn.disabled = true;
        
        try {
            log('Testing API key...', 'info');
            
            const response = await fetch(`${CONFIG.openrouter.url}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${key}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': CONFIG.openrouter.siteUrl,
                    'X-Title': CONFIG.openrouter.siteName
                },
                body: JSON.stringify({
                    model: CONFIG.openrouter.models.v3,
                    messages: [{ role: 'user', content: 'Say "OK"' }],
                    max_tokens: 10
                })
            });
            
            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error?.message || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.choices || !data.choices[0]) {
                throw new Error('Invalid API response');
            }
            
            state.apiKey = key;
            state.aiConnected = true;
            
            saveApiKey(key);
            
            updateDataStatus('ai', true);
            
            successBanner.textContent = '‚úì Connected successfully! Model: ' + CONFIG.openrouter.models.v3;
            successBanner.classList.add('show');
            
            document.getElementById('clear-key-btn').style.display = 'block';
            document.getElementById('analyze-btn').disabled = false;
            
            const reasoning = document.getElementById('ai-reasoning');
            if (state.priceHistory.length < CONFIG.settings.minDataPoints) {
                reasoning.textContent = `AI is ready. Collecting data... ${state.priceHistory.length}/${CONFIG.settings.minDataPoints} points needed.`;
            } else {
                reasoning.textContent = 'AI is ready. Click "Analyze Now" or wait for auto-analysis.';
            }
            
            debugInfo.style.display = 'block';
            document.getElementById('debug-status').textContent = 'Connected to ' + CONFIG.openrouter.models.v3;
            
            log('OpenRouter connected: ' + CONFIG.openrouter.models.v3, 'success');
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ - –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Å—Ä–∞–∑—É
            if (state.priceHistory.length >= CONFIG.settings.minDataPoints) {
                setTimeout(performAIAnalysis, 1000);
            }
            
            if (state.autoAnalysisInterval) {
                clearInterval(state.autoAnalysisInterval);
            }
            
            state.autoAnalysisInterval = setInterval(() => {
                if (document.visibilityState === 'visible' && !state.analysisInProgress) {
                    performAIAnalysis();
                }
            }, CONFIG.settings.analysisInterval);
            
        } catch (error) {
            errorBanner.textContent = 'Connection failed: ' + error.message;
            errorBanner.classList.add('show');
            log('API validation failed: ' + error.message, 'error');
            
            debugInfo.style.display = 'block';
            document.getElementById('debug-status').textContent = 'Error: ' + error.message;
            
        } finally {
            btn.innerHTML = 'Connect AI';
            btn.disabled = false;
        }
    }

    function forceAnalysis() {
        if (!state.analysisInProgress) {
            performAIAnalysis();
        }
    }

    function updateSettings(type, value) {
        if (type === 'interval') {
            CONFIG.settings.analysisInterval = value * 1000;
            document.getElementById('interval-value').textContent = value + 's';
            
            if (state.autoAnalysisInterval) {
                clearInterval(state.autoAnalysisInterval);
                state.autoAnalysisInterval = setInterval(() => {
                    if (document.visibilityState === 'visible' && !state.analysisInProgress) {
                        performAIAnalysis();
                    }
                }, CONFIG.settings.analysisInterval);
            }
        } else if (type === 'newsWeight') {
            CONFIG.settings.newsWeight = parseInt(value);
            document.getElementById('news-weight-value').textContent = value + '%';
        } else if (type === 'threshold') {
            CONFIG.settings.confidenceThreshold = parseInt(value);
            document.getElementById('threshold-value').textContent = value + '%';
        }
    }

    function simulateTrade(type) {
        const amount = parseFloat(document.getElementById('trade-amount').value) || 1000;
        const price = state.currentPrice;
        
        if (!price) {
            log('Cannot trade: No price data', 'error');
            return;
        }
        
        const position = {
            id: Date.now(),
            type: type,
            amount: amount,
            entryPrice: price,
            time: new Date(),
            pnl: 0
        };
        
        state.positions.push(position);
        updatePositions();
        log(`Opened ${type.toUpperCase()}: ${amount} USD @ ${price.toFixed(4)}`, 'success');
    }

    function updatePositions() {
        const container = document.getElementById('positions-list');
        if (state.positions.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 30px;">No open positions</div>';
            return;
        }
        
        const currentPrice = state.currentPrice || 0;
        container.innerHTML = state.positions.map(pos => {
            const pnl = pos.type === 'buy' ? 
                (currentPrice - pos.entryPrice) / pos.entryPrice * 100 :
                (pos.entryPrice - currentPrice) / pos.entryPrice * 100;
            const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
            
            return `
                <div class="position-card">
                    <div class="position-info">
                        <span class="position-type ${pos.type}">${pos.type.toUpperCase()}</span>
                        <span class="position-price">${pos.amount} USD @ ${pos.entryPrice.toFixed(4)}</span>
                    </div>
                    <div class="position-pnl">
                        <div class="pnl-value ${pnlClass}">${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}%</div>
                        <div class="pnl-label">Unrealized P&L</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function log(message, type = 'info') {
        const container = document.getElementById('system-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry ' + type;
        const time = new Date().toLocaleTimeString('ru-RU', { hour12: false });
        entry.innerHTML = `<span class="log-time">${time}</span><span class="log-message">${message}</span>`;
        container.insertBefore(entry, container.firstChild);
        while (container.children.length > 100) container.removeChild(container.lastChild);
    }

    function showError(msg) {
        const reasoning = document.getElementById('ai-reasoning');
        reasoning.innerHTML = '<span style="color: var(--accent-sell);">‚ö†Ô∏è ' + msg + '</span>';
    }

    // ==================== MAIN LOOP ====================
    async function updateData() {
        const [cbrfData, moexData] = await Promise.allSettled([
            fetchCBRF(),
            fetchMOEX()
        ]);
        
        if (cbrfData.status === 'fulfilled' && cbrfData.value) {
            updatePriceDisplay(cbrfData.value);
        } else if (moexData.status === 'fulfilled' && moexData.value) {
            updatePriceDisplay(moexData.value);
        }
        
        if (state.news.length === 0 || Date.now() - state.news[0].time > 600000) {
            await fetchNews();
        }
    }

    // ==================== INIT ====================
    window.addEventListener('DOMContentLoaded', async () => {
        initChart();
        log('USD/RUB Terminal initialized', 'info');
        
        const savedKey = loadApiKey();
        if (savedKey) {
            log('Found saved API key, validating...', 'info');
            document.getElementById('openrouter-key').value = savedKey;
            setTimeout(validateApiKey, 1000);
        }
        
        await updateData();
        
        setInterval(updateData, 30000);
        setInterval(updatePositions, 5000);
    });

    window.addEventListener('error', (e) => log('System error: ' + e.message, 'error'));
    window.addEventListener('unhandledrejection', (e) => log('Async error: ' + e.reason, 'error'));
</script>

</body>
</html>

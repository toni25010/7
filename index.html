–í–æ—Ç –ø–æ–ª–Ω—ã–π, –≥–æ—Ç–æ–≤—ã–π –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫–æ–¥ (index.html).
–ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ –∏ —É–ª—É—á—à–µ–Ω–æ:
 * –†–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ: –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–≤–µ—á–µ–π (10-–º–∏–Ω—É—Ç–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º) —Å –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –ë–∏—Ä–∂–∏ (MOEX). –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–∞–∑—É —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
 * –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å: –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥. –ì—Ä–∞—Ñ–∏–∫ –Ω–µ "—Å–ø–∞–º–∏—Ç" —Ç–æ—á–∫–∞–º–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É, –∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é, –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ 10 –º–∏–Ω—É—Ç.
 * CORS –ü—Ä–æ–∫—Å–∏: –í—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–æ–≤, —Ç–∞–∫ –∫–∞–∫ –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ MOEX –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –ø–æ–ª–∏—Ç–∏–∫–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
 * AI –ê–Ω–∞–ª–∏–∑: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (RSI, MACD, EMA) —Ç–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ —Ä–µ–∞–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏, –ø–æ—ç—Ç–æ–º—É —Å–æ–≤–µ—Ç—ã AI –±—É–¥—É—Ç –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º–∏.
–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –∫–∞–∫ .html —Ñ–∞–π–ª –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USD/RUB AI Trading Terminal | DeepSeek-v3.2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        /* --- STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0e1a;
            --bg-card: #111827;
            --bg-hover: #1f2937;
            --border: #374151;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-buy: #10b981;
            --accent-sell: #ef4444;
            --accent-hold: #f59e0b;
            --accent-info: #3b82f6;
            --accent-ai: #8b5cf6;
            --gradient-ai: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        body {
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: 70px 1fr 220px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }
        .header {
            grid-column: 1 / -1;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            border-bottom: 2px solid var(--border);
        }
        .logo { display: flex; align-items: center; gap: 15px; }
        .logo-icon {
            width: 45px; height: 45px;
            background: linear-gradient(135deg, #ffffff 0%, #0039a6 50%, #d52b1e 100%);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; border: 2px solid rgba(255,255,255,0.3);
        }
        .logo-text h1 { font-size: 1.3em; margin: 0; background: linear-gradient(45deg, #fff, #9ca3af); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-text p { font-size: 0.75em; color: var(--text-secondary); margin: 0; }
        .connection-status { display: flex; align-items: center; gap: 20px; font-size: 0.85em; }
        .status-item { display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: var(--bg-dark); border-radius: 20px; border: 1px solid var(--border); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-sell); transition: all 0.3s; }
        .status-dot.active { background: var(--accent-buy); box-shadow: 0 0 8px var(--accent-buy); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        .sidebar-left, .sidebar-right { background: var(--bg-card); padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .panel-title { font-size: 0.7em; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-secondary); margin-bottom: 12px; font-weight: 700; }
        
        .api-section { background: var(--bg-hover); border-radius: 12px; padding: 20px; border: 1px solid var(--border); }
        .api-input { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-primary); padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; border: 1px solid var(--border); background: var(--bg-dark); color: var(--text-primary); }
        .btn:hover:not(:disabled) { background: var(--border); }
        .btn-ai { background: var(--gradient-ai); border: none; color: white; }
        
        .main-content { background: var(--bg-dark); display: flex; flex-direction: column; position: relative; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; background: var(--bg-card); border-bottom: 1px solid var(--border); }
        .current-price { font-size: 2.5em; font-weight: 700; letter-spacing: -1px; }
        .price-change { font-size: 1.2em; padding: 6px 12px; border-radius: 6px; font-weight: 700; }
        .price-change.positive { background: rgba(16, 185, 129, 0.2); color: var(--accent-buy); }
        .price-change.negative { background: rgba(239, 68, 68, 0.2); color: var(--accent-sell); }
        
        .market-stats { display: flex; gap: 25px; font-size: 0.9em; }
        .stat-value { font-weight: 700; margin-top: 4px; }
        
        .chart-container { flex: 1; position: relative; padding: 25px; }
        .ai-panel { position: absolute; top: 90px; right: 25px; width: 320px; background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 16px; padding: 25px; z-index: 100; box-shadow: 0 25px 60px rgba(0,0,0,0.8); }
        
        .signal-box { text-align: center; padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 2px solid transparent; }
        .signal-buy { border-color: var(--accent-buy); background: rgba(16, 185, 129, 0.1); }
        .signal-sell { border-color: var(--accent-sell); background: rgba(239, 68, 68, 0.1); }
        .signal-hold { border-color: var(--accent-hold); background: rgba(245, 158, 11, 0.1); }
        .signal-text { font-size: 2.2em; font-weight: 800; text-transform: uppercase; }
        
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.85em; }
        .ai-reasoning { margin-top: 20px; padding: 15px; background: var(--bg-dark); border-radius: 8px; border-left: 3px solid var(--accent-ai); font-size: 0.85em; line-height: 1.6; color: var(--text-secondary); max-height: 120px; overflow-y: auto; }

        .bottom-panel { grid-column: 1 / -1; background: var(--bg-card); border-top: 2px solid var(--border); display: grid; grid-template-columns: 1fr 1fr 1fr; overflow: hidden; }
        .panel-section { border-right: 1px solid var(--border); padding: 20px; overflow-y: auto; }
        .log-entry { font-size: 0.8em; margin-bottom: 6px; padding: 4px 8px; border-left: 3px solid; background: var(--bg-dark); }
        .log-entry.info { border-color: var(--accent-info); }
        .log-entry.error { border-color: var(--accent-sell); }
        .log-entry.success { border-color: var(--accent-buy); }

        .indicators-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .indicator-card { background: var(--bg-dark); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--border); }

        @media (max-width: 1200px) {
            .app-container { grid-template-columns: 1fr; grid-template-rows: auto; }
            .sidebar-left, .sidebar-right, .bottom-panel { display: none; }
            .ai-panel { position: relative; top: 0; right: 0; width: 100%; margin-top: 20px; }
        }
        .data-points-counter { font-size: 0.75em; text-align: center; margin-top: 8px; color: var(--text-secondary); }
        .data-points-counter.ready { color: var(--accent-buy); }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üá∑üá∫</div>
            <div class="logo-text">
                <h1>USD/RUB Pro Terminal</h1>
                <p>DeepSeek-v3.2 AI ‚Ä¢ Real-Time MOEX ‚Ä¢ CBRF</p>
            </div>
        </div>
        <div class="connection-status">
            <div class="status-item"><span>MOEX:</span><div class="status-dot" id="moex-status"></div></div>
            <div class="status-item"><span>AI:</span><div class="status-dot" id="ai-status"></div></div>
        </div>
    </header>

    <aside class="sidebar-left">
        <div>
            <div class="panel-title">üîê API Configuration</div>
            <div class="api-section">
                <input type="password" class="api-input" id="openrouter-key" placeholder="OpenRouter API Key (sk-or-...)">
                <button class="btn btn-ai" onclick="validateApiKey()" id="validate-btn">Connect AI</button>
                <div class="data-points-counter" id="data-counter">Data points: 0/14 (need 14 for RSI)</div>
            </div>
        </div>
        <div>
            <div class="panel-title">üì° Data Sources</div>
            <div class="api-section">
                <div style="font-size: 0.8em; margin-bottom: 5px;">Primary: MOEX (Moscow Exchange)</div>
                <div style="font-size: 0.8em; color: var(--text-secondary);">Candles: 10 min | Delay: ~15m</div>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <div class="chart-header">
            <div>
                <div class="current-price" id="main-price">--.----</div>
                <div class="price-change" id="main-change">--</div>
            </div>
            <div class="market-stats">
                <div><div class="panel-title">Open</div><div class="stat-value" id="stat-open">--</div></div>
                <div><div class="panel-title">High</div><div class="stat-value" id="stat-high" style="color:var(--accent-buy)">--</div></div>
                <div><div class="panel-title">Low</div><div class="stat-value" id="stat-low" style="color:var(--accent-sell)">--</div></div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="tradingChart"></canvas>
            
            <div class="ai-panel">
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                    <div style="font-size:1.5em;">üß†</div>
                    <div><b>DeepSeek-v3.2 Analysis</b><div style="font-size:0.7em; color:var(--text-secondary)" id="last-analysis">Waiting...</div></div>
                </div>
                
                <div class="signal-box signal-hold" id="ai-signal-box">
                    <div class="signal-text" id="ai-signal">WAIT</div>
                    <div style="font-size:0.8em; margin-top:5px;">Confidence: <span id="confidence-text">0%</span></div>
                </div>

                <div class="detail-row"><span>Technical Score</span><span id="tech-score">--</span></div>
                <div class="detail-row"><span>Trend</span><span id="trend-score">--</span></div>
                <div class="detail-row"><span>Suggestion</span><span id="suggested-entry" style="color:var(--accent-info)">--</span></div>

                <div class="ai-reasoning" id="ai-reasoning">Connect API key to start analysis.</div>
                <button class="btn btn-ai" onclick="forceAnalysis()" id="analyze-btn" disabled style="margin-top:10px">Analyze Now</button>
            </div>
        </div>
    </main>

    <aside class="sidebar-right">
        <div class="panel-title">üìä Technical Indicators</div>
        <div class="indicators-grid">
            <div class="indicator-card">
                <div style="font-size:0.8em; color:var(--text-secondary)">RSI (14)</div>
                <div class="stat-value" id="ind-rsi">--</div>
            </div>
            <div class="indicator-card">
                <div style="font-size:0.8em; color:var(--text-secondary)">MACD</div>
                <div class="stat-value" id="ind-macd">--</div>
            </div>
            <div class="indicator-card">
                <div style="font-size:0.8em; color:var(--text-secondary)">EMA 20</div>
                <div class="stat-value" id="ind-ema">--</div>
            </div>
            <div class="indicator-card">
                <div style="font-size:0.8em; color:var(--text-secondary)">ATR</div>
                <div class="stat-value" id="ind-atr">--</div>
            </div>
        </div>
    </aside>

    <div class="bottom-panel">
        <div class="panel-section">
            <div class="panel-title">üìù System Log</div>
            <div id="system-log" style="height:100px; overflow-y:auto;"></div>
        </div>
        <div class="panel-section">
            <div class="panel-title">üíº Positions</div>
            <div style="text-align:center; padding:20px; color:var(--text-secondary)">No open positions</div>
        </div>
    </div>
</div>

<script>
    // ==================== CONFIGURATION ====================
    const CONFIG = {
        openrouter: {
            url: 'https://openrouter.ai/api/v1',
            models: { v3: 'deepseek/deepseek-chat' },
            siteUrl: window.location.href,
            siteName: 'USD/RUB Terminal'
        },
        storageKey: 'openrouter_api_key_v2',
        dataSources: {
            proxies: [
                'https://api.allorigins.win/raw?url=',
                'https://api.codetabs.com/v1/proxy?quest=',
                'https://corsproxy.io/?'
            ],
            // ISS MOEX API: Real history candles (10 min interval)
            moexCandles: 'https://iss.moex.com/iss/engines/currency/markets/selt/securities/USD000UTSTOM/candles.json?iss.meta=off&interval=10',
            // Current snapshot
            moexCurrent: 'https://iss.moex.com/iss/engines/currency/markets/selt/securities/USD000UTSTOM.json?iss.meta=off&iss.only=marketdata'
        },
        settings: {
            analysisInterval: 60000,
            minDataPoints: 14,
            maxHistoryPoints: 150
        }
    };

    // ==================== STATE ====================
    let state = {
        apiKey: null,
        priceHistory: [], // {time, price}
        currentPrice: null,
        indicators: {},
        chart: null,
        lastAnalysis: null,
        dayOpen: null,
        dayHigh: null,
        dayLow: null,
        analysisInProgress: false
    };

    // ==================== UTILS ====================
    function log(msg, type='info') {
        const div = document.getElementById('system-log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.innerHTML = `<span style="opacity:0.7">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        div.prepend(entry);
    }

    async function fetchWithProxy(targetUrl) {
        // Try direct first (rarely works for MOEX due to CORS)
        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 3000);
            const res = await fetch(targetUrl, { signal: controller.signal });
            if (res.ok) return res;
        } catch(e) {}

        // Try proxies
        for (const proxy of CONFIG.dataSources.proxies) {
            try {
                const url = proxy + encodeURIComponent(targetUrl);
                const res = await fetch(url);
                if (res.ok) return res;
            } catch (e) { console.warn('Proxy failed:', proxy); }
        }
        throw new Error('All connection methods failed');
    }

    // ==================== DATA CORE ====================
    
    // 1. Load History (Real MOEX Data)
    async function loadHistory() {
        try {
            log('Loading historical candles from MOEX...', 'info');
            // Get last 100 candles (10 min interval)
            const response = await fetchWithProxy(CONFIG.dataSources.moexCandles + '&start=0');
            const json = await response.json();
            
            // Handle MOEX JSON structure
            const data = json.candles || (json.history ? json.history : null);
            if (!data || !data.data) throw new Error('Invalid MOEX data format');

            const cols = data.columns;
            const rows = data.data;
            const idxClose = cols.indexOf('close');
            const idxEnd = cols.indexOf('end');
            const idxHigh = cols.indexOf('high');
            const idxLow = cols.indexOf('low');

            state.priceHistory = rows.map(r => ({
                time: new Date(r[idxEnd]),
                price: r[idxClose],
                high: r[idxHigh],
                low: r[idxLow]
            }));

            // Calc Day stats from history
            if (state.priceHistory.length > 0) {
                const prices = state.priceHistory.map(p => p.price);
                state.dayHigh = Math.max(...prices);
                state.dayLow = Math.min(...prices);
                state.currentPrice = prices[prices.length-1];
                
                log(`Loaded ${state.priceHistory.length} candles.`, 'success');
                updateChart();
                calculateIndicators();
                updateUI(state.currentPrice);
            }
            return true;
        } catch (e) {
            log('History Load Error: ' + e.message, 'error');
            return false;
        }
    }

    // 2. Update Current Price
    async function updateMarketData() {
        try {
            const response = await fetchWithProxy(CONFIG.dataSources.moexCurrent + '&_=' + Date.now());
            const json = await response.json();
            
            // Parse Market Data
            const md = json.marketdata;
            if (!md || !md.data[0]) throw new Error('No market data');
            
            const cols = md.columns;
            const vals = md.data[0];
            const getVal = (name) => vals[cols.indexOf(name)];
            
            const price = getVal('LAST') || getVal('LCURRENTPRICE');
            if (!price) return; // Market closed or no deal

            state.currentPrice = price;
            
            // Update History Logic:
            // Don't add a point every second. Only if time > last candle + 10 mins OR update last candle
            const now = new Date();
            const lastCandle = state.priceHistory[state.priceHistory.length - 1];
            
            if (lastCandle && (now - lastCandle.time) < 10 * 60 * 1000) {
                // Update last candle (it's still forming)
                lastCandle.price = price;
                lastCandle.time = now; // keep time moving for visual
            } else {
                // New candle
                state.priceHistory.push({ time: now, price: price });
                if (state.priceHistory.length > CONFIG.settings.maxHistoryPoints) state.priceHistory.shift();
            }

            // Update UI
            updateUI(price);
            updateChart();
            calculateIndicators();
            
            document.getElementById('moex-status').classList.add('active');
        } catch (e) {
            // Quiet fail
            document.getElementById('moex-status').classList.remove('active');
        }
    }

    function updateUI(price) {
        document.getElementById('main-price').textContent = price.toFixed(4);
        document.getElementById('stat-high').textContent = state.dayHigh?.toFixed(4);
        document.getElementById('stat-low').textContent = state.dayLow?.toFixed(4);
        
        const counter = document.getElementById('data-counter');
        counter.textContent = `Data points: ${state.priceHistory.length}/${CONFIG.settings.minDataPoints}`;
        if(state.priceHistory.length >= CONFIG.settings.minDataPoints) counter.classList.add('ready');

        // Calculate change based on history[0] (start of loaded period) or day open
        const startPrice = state.priceHistory[0]?.price || price;
        const change = ((price - startPrice) / startPrice * 100);
        const changeEl = document.getElementById('main-change');
        changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
        changeEl.className = 'price-change ' + (change >= 0 ? 'positive' : 'negative');
    }

    // ==================== INDICATORS ====================
    function calculateIndicators() {
        const prices = state.priceHistory.map(p => p.price);
        if (prices.length < CONFIG.settings.minDataPoints) return;

        // RSI
        const rsi = calcRSI(prices, 14);
        document.getElementById('ind-rsi').textContent = rsi.toFixed(1);
        document.getElementById('ind-rsi').style.color = rsi > 70 ? 'var(--accent-sell)' : rsi < 30 ? 'var(--accent-buy)' : 'var(--text-secondary)';

        // EMA
        const ema20 = calcEMA(prices, 20);
        document.getElementById('ind-ema').textContent = ema20.toFixed(2);

        // MACD (12, 26, 9)
        const macd = calcMACD(prices);
        document.getElementById('ind-macd').textContent = macd.histogram.toFixed(4);
        document.getElementById('ind-macd').style.color = macd.histogram > 0 ? 'var(--accent-buy)' : 'var(--accent-sell)';

        state.indicators = { rsi, ema20, macd, current: prices[prices.length-1] };
    }

    function calcEMA(prices, period) {
        const k = 2 / (period + 1);
        let ema = prices[0];
        for (let i = 1; i < prices.length; i++) ema = prices[i] * k + ema * (1 - k);
        return ema;
    }

    function calcRSI(prices, period) {
        let gains = 0, losses = 0;
        for (let i = prices.length - period; i < prices.length; i++) {
            const diff = prices[i] - prices[i-1];
            if (diff >= 0) gains += diff; else losses -= diff;
        }
        if (losses === 0) return 100;
        return 100 - (100 / (1 + (gains/period)/(losses/period)));
    }

    function calcMACD(prices) {
        const ema12 = calcEMA(prices, 12);
        const ema26 = calcEMA(prices, 26);
        const line = ema12 - ema26;
        // Simplified Signal line (approx)
        return { histogram: line - (line * 0.2) }; 
    }

    // ==================== AI LOGIC ====================
    async function performAnalysis() {
        if (!state.apiKey || state.priceHistory.length < 14) return;
        
        const btn = document.getElementById('analyze-btn');
        btn.innerHTML = 'Analyzing...';
        btn.disabled = true;

        const ind = state.indicators;
        const prompt = `
        Asset: USD/RUB. Current Price: ${state.currentPrice}.
        Indicators (Real Data):
        RSI(14): ${ind.rsi.toFixed(1)}
        EMA(20): ${ind.ema20.toFixed(2)}
        MACD Hist: ${ind.macd.histogram.toFixed(4)}
        
        Analyze technicals. Return JSON:
        { "signal": "BUY"|"SELL"|"HOLD", "confidence": 0-100, "reasoning": "Short Russian text", "tech_score": 0-100, "entry": number }
        `;

        try {
            const res = await fetch(`${CONFIG.openrouter.url}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: CONFIG.openrouter.models.v3,
                    messages: [{role: 'user', content: prompt}],
                    response_format: { type: 'json_object' } // Force JSON if supported
                })
            });

            const data = await res.json();
            const result = JSON.parse(data.choices[0].message.content);
            updateAISignal(result);
            log('AI Analysis complete', 'success');
        } catch (e) {
            log('AI Error: ' + e.message, 'error');
            // Fallback mock result for UI testing
            updateAISignal({
                signal: ind.rsi < 30 ? 'BUY' : ind.rsi > 70 ? 'SELL' : 'HOLD',
                confidence: 65,
                reasoning: "–û—à–∏–±–∫–∞ AI, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ–ª–ª–±–µ–∫ –∞–ª–≥–æ—Ä–∏—Ç–º.",
                tech_score: 50
            });
        } finally {
            btn.innerHTML = 'Analyze Now';
            btn.disabled = false;
        }
    }

    function updateAISignal(res) {
        const box = document.getElementById('ai-signal-box');
        box.className = `signal-box signal-${res.signal.toLowerCase()}`;
        document.getElementById('ai-signal').textContent = res.signal;
        document.getElementById('confidence-text').textContent = res.confidence + '%';
        document.getElementById('ai-reasoning').textContent = res.reasoning;
        document.getElementById('tech-score').textContent = res.tech_score + '/100';
        document.getElementById('suggested-entry').textContent = res.entry || state.currentPrice;
        document.getElementById('last-analysis').textContent = new Date().toLocaleTimeString();
    }

    function validateApiKey() {
        const key = document.getElementById('openrouter-key').value;
        if (key.startsWith('sk-or-')) {
            state.apiKey = key;
            localStorage.setItem(CONFIG.storageKey, key);
            log('API Key Saved', 'success');
            document.getElementById('analyze-btn').disabled = false;
            document.getElementById('ai-reasoning').textContent = 'Ready to analyze.';
            document.getElementById('ai-status').classList.add('active');
        } else {
            log('Invalid API Key format', 'error');
        }
    }

    function forceAnalysis() { performAnalysis(); }

    // ==================== CHART ====================
    function initChart() {
        const ctx = document.getElementById('tradingChart').getContext('2d');
        state.chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'USD/RUB',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } },
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af' }
                    },
                    y: {
                        grid: { color: '#374151' },
                        ticks: { color: '#9ca3af', callback: v => v.toFixed(2) }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function updateChart() {
        if (!state.chart) return;
        state.chart.data.datasets[0].data = state.priceHistory.map(p => ({x: p.time, y: p.price}));
        state.chart.update('none');
    }

    // ==================== INIT ====================
    window.addEventListener('DOMContentLoaded', async () => {
        initChart();
        const savedKey = localStorage.getItem(CONFIG.storageKey);
        if (savedKey) {
            document.getElementById('openrouter-key').value = savedKey;
            validateApiKey();
        }

        // 1. Initial Load
        await loadHistory();

        // 2. Start Loops
        setInterval(updateMarketData, 15000); // Check price every 15s
    });

</script>
</body>
</html>


<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si AI Terminal | Pro</title>
    <script src="https://unpkg.com/lightweight-charts@4.0.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { 
            --bg: #0d1117; 
            --card: #161b22; 
            --border: #30363d; 
            --text: #c9d1d9; 
            --accent: #58a6ff; 
            --buy: #238636; 
            --sell: #da3633; 
            --hold: #d29922;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); padding: 12px; min-height: 100vh; }
        
        h2 { text-align: center; font-size: 1.2rem; margin: 0 0 12px 0; color: var(--text); letter-spacing: 1px; }
        
        /* Grid Layout */
        .grid { display: grid; grid-template-columns: 2.5fr 1fr; gap: 16px; max-width: 1600px; margin: 0 auto; height: calc(100vh - 60px); }
        
        /* Cards */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Chart Area */
        #chart { flex-grow: 1; width: 100%; position: relative; background: var(--card); border-radius: 8px; overflow: hidden; }
        .tf-selector { display: flex; gap: 6px; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
        .tf-btn { background: transparent; color: var(--text); border: 1px solid var(--border); padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; transition: 0.2s; }
        .tf-btn:hover { background: #21262d; }
        .tf-btn.active { background: var(--accent); color: #0d1117; border-color: var(--accent); font-weight: bold; }
        
        /* Ticker Info */
        .ticker-wrap { display: flex; justify-content: space-between; background: #0d1117; padding: 10px; border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border); }
        .ticker-val { font-size: 20px; font-weight: 700; font-family: 'Courier New', monospace; letter-spacing: -1px; }
        .ticker-label { font-size: 9px; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        
        /* Signal Box */
        .signal-display { text-align: center; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 12px; background: rgba(255,255,255,0.02); transition: 0.3s; }
        .signal-display.buy { border-color: var(--buy); background: rgba(35, 134, 54, 0.1); color: #3fb950; }
        .signal-display.sell { border-color: var(--sell); background: rgba(218, 54, 51, 0.1); color: #f85149; }
        .signal-display.hold { border-color: var(--hold); background: rgba(210, 153, 34, 0.1); color: #d29922; }
        
        /* Trade Plan */
        .trade-plan-box { background: #0d1117; border-radius: 8px; padding: 10px; border: 1px solid var(--border); display: none; margin-bottom: 12px; }
        .plan-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
        .plan-row:last-child { border-bottom: none; }
        .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        
        /* News Feed (FIXED STYLES) */
        .news-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px; }
        .news-header { font-size: 11px; font-weight: 600; color: #8b949e; margin-bottom: 8px; text-transform: uppercase; }
        .news-box { overflow-y: auto; flex-grow: 1; padding-right: 4px; scrollbar-width: thin; scrollbar-color: #30363d transparent; }
        
        .news-item { 
            padding: 8px 10px; 
            border-left: 2px solid var(--border); 
            margin-bottom: 6px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 0 4px 4px 0;
            transition: 0.2s;
        }
        .news-item:hover { background: rgba(255,255,255,0.06); border-left-color: var(--accent); }
        .news-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .news-source { padding: 2px 5px; border-radius: 3px; font-size: 9px; font-weight: bold; color: #fff; }
        .news-time { color: #8b949e; font-size: 9px; }
        .news-link { color: var(--text); text-decoration: none; font-size: 11px; line-height: 1.3; display: block; }
        .news-link:hover { color: var(--accent); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 12px; display: none; }
        .stat-item { background: #0d1117; padding: 6px 8px; border-radius: 4px; border: 1px solid var(--border); }
        .stat-label { color: #8b949e; font-size: 9px; margin-bottom: 2px; }
        .stat-val { font-size: 12px; font-weight: 600; }
        
        /* Controls */
        button.primary { background: var(--buy); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 6px; width: 100%; font-weight: 600; font-size: 12px; transition: 0.2s; }
        button.primary:hover { opacity: 0.9; }
        
        input { width: 100%; padding: 8px; background: #0d1117; color: white; border: 1px solid var(--border); border-radius: 6px; font-size: 11px; margin-top: 4px; }
        
        /* Loader */
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); z-index: 10; font-size: 11px; display: flex; align-items: center; gap: 8px; }
        .spinner { width: 10px; height: 10px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-msg { color: var(--sell); font-size: 10px; margin-top: 8px; line-height: 1.3; display: none; background: rgba(218, 54, 51, 0.1); padding: 6px; border-radius: 4px; }

        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; height: auto; } #chart { height: 350px; } .news-box { max-height: 300px; } }
    </style>
</head>
<body>
    <h2>Si AI TERMINAL</h2>

    <div class="grid">
        <div class="card">
            <div class="tf-selector" id="tfSelector">
                <button class="tf-btn active" data-tf="15">M15</button>
                <button class="tf-btn" data-tf="60">H1</button>
                <button class="tf-btn" data-tf="1440">D1</button>
                <div style="margin-left:auto; font-size: 10px; display:flex; align-items:center; gap:8px; color: #8b949e;">
                    <span id="contractName">Поиск контракта...</span>
                    <span id="lastTradeTime">--:--:--</span>
                </div>
            </div>
            
            <div id="chart"><div id="loading"><div class="spinner"></div> Инициализация...</div></div>
            
            <div class="news-container">
                <div class="news-header">Лента новостей (РБК / Investing)</div>
                <div class="news-box" id="newsList">
                    </div>
            </div>
        </div>

        <div class="card">
            <div class="ticker-wrap">
                <div>
                    <div class="ticker-label">LAST PRICE</div>
                    <div class="ticker-val" id="currentPrice">--</div>
                </div>
                <div style="text-align: right;">
                    <div class="ticker-label">CHANGE</div>
                    <div class="ticker-val" id="changePercent">--%</div>
                </div>
            </div>

            <div id="signal_ui" class="signal-display hold">
                <div style="font-size: 9px; opacity: 0.7; text-transform:uppercase;">AI Signal</div>
                <div id="signal_text" style="font-size: 20px; font-weight: bold; margin: 4px 0;">WAIT</div>
                <div id="signal_confidence" style="font-size: 10px;">Ready</div>
            </div>

            <div id="tradePlanBox" class="trade-plan-box">
                <div style="text-align: center; font-size: 10px; font-weight: 600; color: var(--accent); margin-bottom: 6px;">СЕТАП</div>
                <div class="plan-row"><span><span class="dot" style="background: var(--accent);"></span>Entry</span><span id="aiEntry" style="color: var(--accent)">--</span></div>
                <div class="plan-row"><span><span class="dot" style="background: var(--buy);"></span>Take</span><span id="aiTP" style="color: var(--buy)">--</span></div>
                <div class="plan-row"><span><span class="dot" style="background: var(--sell);"></span>Stop</span><span id="aiSL" style="color: var(--sell)">--</span></div>
            </div>

            <div id="ai_desc" class="error-msg"></div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-item"><div class="stat-label">RSI (14)</div><div class="stat-val" id="statRsi">-</div></div>
                <div class="stat-item"><div class="stat-label">ATR (14)</div><div class="stat-val" id="statAtr">-</div></div>
                <div class="stat-item"><div class="stat-label">MACD</div><div class="stat-val" id="statMacd">-</div></div>
                <div class="stat-item"><div class="stat-label">TREND (EMA20)</div><div class="stat-val" id="statTrend">-</div></div>
            </div>

            <div style="margin-top: auto;">
                <button class="primary" onclick="runAnalysis()">ЗАПРОСИТЬ АНАЛИЗ (AI)</button>
                
                <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border);">
                    <label style="font-size: 10px; color: #8b949e;">OpenRouter API Key:</label>
                    <input type="password" id="api_key_input" placeholder="sk-or-..." value="">
                    <button onclick="saveKey()" style="margin-top: 6px; width: 100%; background: #21262d; border: 1px solid var(--border); color: #c9d1d9; padding: 6px; border-radius: 4px; font-size: 10px; cursor: pointer;">Сохранить ключ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIG ==================
        const MOEX_BASE = "https://iss.moex.com/iss/engines/futures/markets/forts";
        
        // State
        let currentTicker = null;
        let chart = null;
        let candleSeries = null;
        let priceLines = [];
        let historyData = [];
        let allNews = []; 
        let currentTf = 15;

        // ==================== 1. CONTRACT DETECTION ====================
        const antiCache = () => `_=${Date.now()}`;

        async function detectActiveContract() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            loading.innerHTML = '<div class="spinner"></div> Поиск Si...';
            
            const url = `${MOEX_BASE}/securities.json?q=Si&iss.only=marketdata,securities&${antiCache()}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                // Ищем тикер с наибольшим объемом торгов (VALTODAY)
                const cols = data.marketdata.columns;
                const rows = data.marketdata.data;
                const idxVol = cols.indexOf('VALTODAY');
                const idxSecId = data.securities.columns.indexOf('SECID');
                const secRows = data.securities.data;

                let best = { ticker: 'SiH6', vol: 0 };

                rows.forEach((row, i) => {
                    const secId = secRows[i] ? secRows[i][idxSecId] : '';
                    if (!secId.startsWith('Si')) return; // Фильтр только Si
                    const vol = row[idxVol] || 0;
                    if (vol > best.vol) best = { ticker: secId, vol: vol };
                });

                currentTicker = best.ticker;
                document.getElementById('contractName').innerText = `Контракт: ${currentTicker}`;
                return true;
            } catch(e) {
                console.error(e);
                currentTicker = "SiH6"; // Fallback
                return false;
            }
        }

        // ==================== 2. MARKET DATA ==================
        async function fetchQuotes() {
            if(!currentTicker) return;
            const url = `${MOEX_BASE}/securities/${currentTicker}.json?iss.only=marketdata&${antiCache()}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const cols = data.marketdata.columns;
                const row = data.marketdata.data[0];
                if(!row) return;
                
                const idx = { last: cols.indexOf('LAST'), chg: cols.indexOf('CHANGE'), time: cols.indexOf('SYSTIME'), prev: cols.indexOf('PREVPRICE') };
                
                const quote = {
                    price: row[idx.last],
                    change: row[idx.chg],
                    prev: row[idx.prev],
                    time: row[idx.time]
                };
                
                updatePriceUI(quote);
                if(quote.price) updateChartLive(quote.price);

            } catch(e) { console.error("Quote error", e); }
        }

        async function fetchCandles(tf = 15) {
            if(!currentTicker) return;
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            const d = new Date();
            d.setDate(d.getDate() - 5); // Последние 5 дней
            const from = d.toISOString().split('T')[0];
            
            const url = `${MOEX_BASE}/securities/${currentTicker}/candles.json?interval=${tf}&from=${from}&${antiCache()}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (!data.candles?.data?.length) throw new Error("Нет свечей");

                const cols = data.candles.columns;
                const idx = { o: cols.indexOf('open'), c: cols.indexOf('close'), h: cols.indexOf('high'), l: cols.indexOf('low'), t: cols.indexOf('begin') };

                historyData = data.candles.data.map(r => ({
                    time: Math.floor(new Date(r[idx.t]).getTime() / 1000),
                    open: r[idx.o], high: r[idx.h], low: r[idx.l], close: r[idx.c]
                })).filter(c => c.close > 0);

                renderChart(historyData);
                calcTech(); // Считаем индикаторы сразу
            } catch(e) {
                loading.innerHTML = `<span style='color:var(--sell); font-size:10px;'>Ошибка: ${e.message}</span>`;
            }
            loading.style.display = 'none';
        }

        // ==================== 3. NEWS (CORRECTED MODULE) ==================
        async function fetchNews() {
            const list = document.getElementById('newsList');
            
            // Если список пуст, показываем статус
            if (!list.children.length) {
                list.innerHTML = '<div style="color:#8b949e; text-align:center; padding:10px; font-size:11px;">↻ Загрузка ленты...</div>';
            }

            // Источники: РБК и Investing
            const sources = [
                { name: 'РБК', url: 'https://rssexport.rbc.ru/rbcnews/news/20/full.rss', color: '#238636' }, // Зеленый
                { name: 'Investing', url: 'https://ru.investing.com/rss/news_285.rss', color: '#d29922' } // Оранжевый
            ];

            let rawItems = [];

            // Параллельная загрузка через JSON-прокси (allorigins.win/get)
            const promises = sources.map(async (src) => {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(src.url)}`;
                
                try {
                    const res = await fetch(proxyUrl);
                    const data = await res.json();
                    
                    if (!data.contents) return [];

                    const parser = new DOMParser();
                    const xml = parser.parseFromString(data.contents, "text/xml");
                    const items = Array.from(xml.querySelectorAll("item"));

                    return items.map(item => {
                        const pubDate = item.querySelector("pubDate")?.textContent;
                        return {
                            source: src.name,
                            color: src.color,
                            title: item.querySelector("title")?.textContent || "Без заголовка",
                            link: item.querySelector("link")?.textContent || "#",
                            ts: pubDate ? new Date(pubDate).getTime() : Date.now(),
                            dateObj: pubDate ? new Date(pubDate) : new Date()
                        };
                    });
                } catch (e) {
                    console.warn(`Ошибка источника ${src.name}:`, e);
                    return [];
                }
            });

            const results = await Promise.all(promises);
            results.forEach(arr => rawItems = rawItems.concat(arr));

            // Сортировка по времени (новые сверху)
            rawItems.sort((a, b) => b.ts - a.ts);

            // Сохраняем топ-5 для AI
            allNews = rawItems.slice(0, 5).map(n => ({ title: n.title, link: n.link }));

            // Рендерим топ-15
            const uiItems = rawItems.slice(0, 15);
            
            if (uiItems.length === 0) {
                list.innerHTML = '<div style="color:#da3633; font-size:10px; text-align:center;">Не удалось получить новости.</div>';
                return;
            }

            let html = '';
            const now = Date.now();

            uiItems.forEach(n => {
                const diffMin = (now - n.ts) / 60000;
                let timeStr;
                if (diffMin < 60) timeStr = `${Math.floor(diffMin)} мин.`;
                else if (diffMin < 1440) timeStr = `${Math.floor(diffMin/60)} ч.`;
                else timeStr = n.dateObj.toLocaleDateString('ru-RU', {day:'numeric', month:'short'});

                html += `
                    <div class="news-item">
                        <div class="news-meta">
                            <span class="news-source" style="background:${n.color}">${n.source}</span>
                            <span class="news-time">${timeStr}</span>
                        </div>
                        <a href="${n.link}" target="_blank" class="news-link">${n.title}</a>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        // ==================== 4. CHART ENGINE ==================
        function updateChartLive(price) {
            if (!candleSeries || !historyData.length) return;

            const now = Math.floor(Date.now() / 1000);
            const tfSeconds = currentTf * 60;
            // Округляем до начала текущего интервала
            const currentCandleTime = Math.floor(now / tfSeconds) * tfSeconds;

            let lastCandle = historyData[historyData.length - 1];

            if (lastCandle.time >= currentCandleTime) {
                // Обновляем текущую свечу
                const upd = { 
                    time: lastCandle.time, 
                    open: lastCandle.open, 
                    high: Math.max(lastCandle.high, price), 
                    low: Math.min(lastCandle.low, price), 
                    close: price 
                };
                historyData[historyData.length - 1] = upd;
                candleSeries.update(upd);
            } else {
                // Новая свеча
                const newCandle = { time: currentCandleTime, open: price, high: price, low: price, close: price };
                historyData.push(newCandle);
                candleSeries.update(newCandle);
            }
        }

        function renderChart(data) {
            const cont = document.getElementById('chart');
            cont.innerHTML = '';
            priceLines = [];

            chart = LightweightCharts.createChart(cont, {
                layout: { background: { color: '#161b22' }, textColor: '#8b949e' },
                grid: { vertLines: { color: '#222' }, horzLines: { color: '#222' } },
                timeScale: { timeVisible: true, borderColor: '#30363d' },
                rightPriceScale: { borderColor: '#30363d' },
                crosshair: { mode: 1 },
                width: cont.clientWidth, 
                height: cont.clientHeight
            });

            candleSeries = chart.addCandlestickSeries({ 
                upColor: '#238636', 
                downColor: '#da3633', 
                borderVisible: false, 
                wickUpColor: '#238636', 
                wickDownColor: '#da3633' 
            });
            
            candleSeries.setData(data);
            chart.timeScale().fitContent();

            // Авто-ресайз
            new ResizeObserver(entries => {
                if (entries.length === 0 || entries[0].target !== cont) return;
                const { width, height } = entries[0].contentRect;
                chart.resize(width, height);
            }).observe(cont);
        }

        function drawPlan(e, tp, sl) {
            if(!candleSeries) return;
            // Удаляем старые линии
            priceLines.forEach(l => candleSeries.removePriceLine(l));
            priceLines = [];
            
            const mkLine = (p, c, t) => candleSeries.createPriceLine({ 
                price: p, color: c, lineWidth: 2, lineStyle: 2, title: t, axisLabelVisible: true 
            });
            
            priceLines.push(mkLine(e, '#58a6ff', 'ENTRY'));
            priceLines.push(mkLine(tp, '#238636', 'TP'));
            priceLines.push(mkLine(sl, '#da3633', 'SL'));
        }

        // ==================== 5. ANALYSIS LOGIC ==================
        function updatePriceUI(q) {
            if(!q || !q.price) return;
            document.getElementById('currentPrice').innerText = q.price.toFixed(0);
            if(q.prev > 0) {
                const pct = ((q.price - q.prev)/q.prev * 100);
                const el = document.getElementById('changePercent');
                el.innerText = (pct>=0?'+':'') + pct.toFixed(2)+'%';
                el.style.color = pct>=0?'var(--buy)':'var(--sell)';
            }
            if(q.time) document.getElementById('lastTradeTime').innerText = new Date(q.time).toLocaleTimeString('ru-RU');
        }

        function calcTech() {
            if (historyData.length < 20) return null;
            const c = historyData.map(d=>d.close);
            
            // RSI
            let g=0,l=0;
            for(let i=c.length-14;i<c.length;i++){ const d=c[i]-c[i-1]; if(d>0)g+=d; else l-=d; }
            const rsi = l===0 ? 100 : 100 - (100/(1+g/l));
            
            // EMA
            const ema = (p,per) => p.slice(1).reduce((e,v)=>v*(2/(per+1))+e*(1-2/(per+1)), p[0]);
            
            // MACD
            const macd = ema(c,12)-ema(c,26);
            
            // ATR
            let tr=0;
            for(let i=historyData.length-14;i<historyData.length;i++){ 
                const h=historyData[i].high, low=historyData[i].low, pc=historyData[i-1].close; 
                tr+=Math.max(h-low, Math.abs(h-pc), Math.abs(low-pc)); 
            }
            const atr = tr/14;

            // UI Update
            document.getElementById('statsGrid').style.display='grid';
            document.getElementById('statRsi').innerText=rsi.toFixed(1);
            document.getElementById('statRsi').style.color = rsi>70 ? 'var(--sell)' : rsi<30 ? 'var(--buy)' : 'var(--text)';
            
            document.getElementById('statAtr').innerText=atr.toFixed(0);
            document.getElementById('statMacd').innerText=macd.toFixed(1);
            
            const isBull = c[c.length-1] > ema(c,20);
            const trendEl = document.getElementById('statTrend');
            trendEl.innerText = isBull ? 'BULL' : 'BEAR';
            trendEl.style.color = isBull ? 'var(--buy)' : 'var(--sell)';

            return {rsi, atr, macd, price:c[c.length-1]};
        }

        async function runAnalysis() {
            const key = document.getElementById('api_key_input').value.trim();
            if(!key) { alert("Введите API Key от OpenRouter!"); return; }
            
            const tech = calcTech();
            if (!tech) { alert("График загружается, подождите..."); return; }

            const btn = document.querySelector('button.primary');
            const originalText = btn.innerText;
            btn.innerText = "АНАЛИЗ...";
            btn.disabled = true;

            document.getElementById('signal_text').innerText = "...";
            document.getElementById('tradePlanBox').style.display = 'none';
            document.getElementById('ai_desc').style.display = 'none';

            let newsContext = "";
            if (allNews.length > 0) {
                newsContext = "ПОСЛЕДНИЕ НОВОСТИ:\n" + allNews.map((n, i) => `${i+1}. ${n.title}`).join("\n");
            } else {
                newsContext = "Новостной фон нейтральный.";
            }

            const prompt = `Роль: Профессиональный скальпер на Si (USDRUB futures).
ВХОДНЫЕ ДАННЫЕ:
Цена: ${tech.price}
Таймфрейм: ${currentTf} мин
RSI (14): ${tech.rsi.toFixed(1)}
MACD: ${tech.macd.toFixed(1)}
ATR (14): ${tech.atr.toFixed(0)}

${newsContext}

ЗАДАЧА:
1. Оцени ситуацию.
2. Дай сигнал: BUY, SELL или WAIT.
3. Рассчитай Entry, TP (Take Profit) и SL (Stop Loss) исходя из ATR (TP ~1.5 ATR, SL ~1 ATR).

ФОРМАТ ОТВЕТА (JSON only):
{
  "signal": "BUY" | "SELL" | "WAIT",
  "confidence": 0-100,
  "entry": number,
  "tp": number,
  "sl": number,
  "reason": "Краткое обоснование на русском (макс 15 слов)"
}`;

            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        model: "deepseek/deepseek-r1:free", // Можно сменить на платную (deepseek/deepseek-v3)
                        messages: [{role:"user", content:prompt}] 
                    })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                // Парсим JSON из ответа (иногда модель добавляет текст вокруг)
                const content = data.choices[0].message.content;
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("Некорректный ответ нейросети");
                
                const json = JSON.parse(jsonMatch[0]);
                updateUI(json, tech.price);

            } catch(e) {
                document.getElementById('signal_text').innerText = "ERR";
                document.getElementById('ai_desc').innerText = e.message;
                document.getElementById('ai_desc').style.display = 'block';
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function updateUI(j, p) {
            const ui = document.getElementById('signal_ui');
            const map = { 'BUY': 'buy', 'SELL': 'sell', 'WAIT': 'hold' };
            ui.className = "signal-display " + (map[j.signal] || 'hold');
            
            document.getElementById('signal_text').innerText = j.signal;
            document.getElementById('signal_confidence').innerText = `Confidence: ${j.confidence}%`;
            
            document.getElementById('ai_desc').innerText = j.reason;
            document.getElementById('ai_desc').style.display = 'block';
            
            if(j.signal !== 'WAIT' && j.entry && j.tp) {
                document.getElementById('tradePlanBox').style.display='block';
                document.getElementById('aiEntry').innerText = j.entry;
                document.getElementById('aiTP').innerText = j.tp;
                document.getElementById('aiSL').innerText = j.sl;
                drawPlan(j.entry, j.tp, j.sl);
            }
        }

        function saveKey() { 
            const k = document.getElementById('api_key_input').value;
            localStorage.setItem('si_k', k); 
            alert("Ключ сохранен!"); 
        }

        // ==================== INIT ==================
        window.onload = async () => {
            const k = localStorage.getItem('si_k');
            if(k) document.getElementById('api_key_input').value = k;

            await detectActiveContract();
            await Promise.all([fetchQuotes(), fetchCandles(15), fetchNews()]);

            // Таймеры обновлений
            setInterval(fetchQuotes, 2000); // Цена каждые 2 сек
            setInterval(() => fetchCandles(currentTf), 60000); // Свечи каждую минуту
            setInterval(fetchNews, 300000); // Новости раз в 5 мин

            // Обработчик таймфреймов
            document.getElementById('tfSelector').onclick = (e) => {
                const btn = e.target.closest('.tf-btn');
                if(!btn) return;
                document.querySelectorAll('.tf-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                currentTf = parseInt(btn.dataset.tf);
                fetchCandles(currentTf);
            };
        };
    </script>
</body>
</html>

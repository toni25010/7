async function fetchNews() {
    const list = document.getElementById('newsList');
    list.innerHTML = '<div style="color:#8b949e">Загрузка Finam и РБК...</div>';
    
    // Источники новостей
    const sources = [
        { name: 'Finam', url: 'https://www.finam.ru/analysis/conews/rsspoint' },
        { name: 'РБК', url: 'https://rssexport.rbc.ru/rbcnews/news/20/full.rss' },
        { name: 'РБК (alt)', url: 'https://static.feed.rbc.ru/rbc/logical/footer/news.rss' },
        { name: 'РБК (yandex)', url: 'https://www.rbc.ru/v8/rss/yandex/outside/news.rss' } // ещё один вариант
    ];

    // Прокси с приоритетом (первые – наиболее быстрые/надёжные)
    const proxies = [
        { name: 'rss2json', fn: async (src) => {
            const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(src.url)}`;
            const res = await fetch(apiUrl);
            const data = await res.json();
            if (data.status !== 'ok') throw new Error('rss2json error');
            return data.items || [];
        }},
        { name: 'thingproxy', fn: async (src) => {
            const proxyUrl = `https://thingproxy.freeboard.io/fetch/${src.url}`;
            const res = await fetch(proxyUrl);
            const text = await res.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");
            const items = xml.querySelectorAll("item");
            return Array.from(items).map(item => ({
                title: item.querySelector('title')?.textContent || '',
                link: item.querySelector('link')?.textContent || '',
                pubDate: item.querySelector('pubDate')?.textContent || ''
            }));
        }},
        { name: 'allorigins', fn: async (src) => {
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(src.url)}`;
            const res = await fetch(proxyUrl);
            const text = await res.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");
            const items = xml.querySelectorAll("item");
            return Array.from(items).map(item => ({
                title: item.querySelector('title')?.textContent || '',
                link: item.querySelector('link')?.textContent || '',
                pubDate: item.querySelector('pubDate')?.textContent || ''
            }));
        }},
        { name: 'corsproxy', fn: async (src) => {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(src.url)}`;
            const res = await fetch(proxyUrl);
            const text = await res.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");
            const items = xml.querySelectorAll("item");
            return Array.from(items).map(item => ({
                title: item.querySelector('title')?.textContent || '',
                link: item.querySelector('link')?.textContent || '',
                pubDate: item.querySelector('pubDate')?.textContent || ''
            }));
        }},
        { name: 'codetabs', fn: async (src) => {
            const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(src.url)}`;
            const res = await fetch(proxyUrl);
            const text = await res.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");
            const items = xml.querySelectorAll("item");
            return Array.from(items).map(item => ({
                title: item.querySelector('title')?.textContent || '',
                link: item.querySelector('link')?.textContent || '',
                pubDate: item.querySelector('pubDate')?.textContent || ''
            }));
        }}
    ];

    allNews = [];
    let newsHtml = '';
    const now = new Date();

    for (const src of sources) {
        let items = [];
        let usedProxy = null;

        for (const proxy of proxies) {
            try {
                console.log(`Trying ${proxy.name} for ${src.name}...`);
                items = await proxy.fn(src);
                if (items.length > 0) {
                    usedProxy = proxy.name;
                    break;
                }
            } catch (e) {
                console.warn(`${proxy.name} failed for ${src.name}:`, e.message || e);
            }
        }

        if (!usedProxy) {
            console.error(`All proxies failed for ${src.name}`);
            continue;
        }

        console.log(`Success with ${usedProxy} for ${src.name}, got ${items.length} items`);

        items.slice(0, 5).forEach(item => {
            const title = item.title;
            const link = item.link;
            let date = new Date();
            if (item.pubDate) {
                date = new Date(item.pubDate);
                if (isNaN(date)) date = new Date();
            }
            const hoursAgo = (now - date) / 3600000;

            if (hoursAgo < 24) allNews.push({ title, link, source: src.name });

            const timeStr = hoursAgo < 1 ? 'Только что' : hoursAgo < 24 ? `${Math.round(hoursAgo)}ч назад` : date.toLocaleDateString('ru-RU');

            newsHtml += `
                <div class="news-item">
                    <span class="news-time">${src.name} • ${timeStr}</span>
                    <a href="${link}" target="_blank" style="color:var(--text);text-decoration:none;">${title}</a>
                </div>
            `;
        });
        
        if (allNews.length >= 15) break; // ограничим общее количество
    }

    if (newsHtml) {
        list.innerHTML = newsHtml;
    } else {
        list.innerHTML = '<div style="color:#d29922; font-size:11px; padding:5px;">Не удалось загрузить новости. Демо-лента:</div>';
        allNews = [
            { title: "Рынок ожидает решения ЦБ по ставке" },
            { title: "Нефть дорожает на фоне геополитики" },
            { title: "Рубль стабилен к основным валютам" }
        ];
        allNews.forEach(item => {
            newsHtml += `
                <div class="news-item">
                    <span class="news-time">Демо • только что</span>
                    <span style="color:var(--text);">${item.title}</span>
                </div>
            `;
        });
        list.innerHTML += newsHtml;
    }
}
